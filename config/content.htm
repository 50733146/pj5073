<h1>About</h1>
<h4>五專部專題題目:</h4>
<h4 style="padding-left: 30px;"><span style="background-color: #ffff99;">網際內容管理系統在精密機械工程教學與研究上的應用</span></h4>
<h4 style="padding-left: 30px;">Application of Web-based Content Management Systems in Teaching and Research of Precision Mechanical Engineering</h4>
<h4 style="padding-left: 30px;">專題動機:</h4>
<p style="padding-left: 60px;">探討如何利用 <a href="https://www.fossil-scm.org">Fossil SCM</a> 虛擬與實體伺服器, 讓五專精密機械工程科相關師生, 得以透過學校配發的 @gm 帳號登入, 並在網際內容管理系統中進行知識管理與互動, 擬藉此提升課程教學與專題研究效益.</p>
<h4 style="padding-left: 30px;">研究步驟:</h4>
<p style="padding-left: 60px;">從 Windows 與 Ubuntu 中編譯 <a href="https://www.fossil-scm.org">Fossil SCM</a> 套件開始, 分別取得 client 與 server 端的可執行檔案後, 將 <a href="https://www.fossil-scm.org">Fossil SCM</a> 安裝配置在一台實體或虛擬主機上, 利用 Python + <a href="https://flask.palletsprojects.com/en/2.0.x/">Flask</a> 著手編寫 <a href="https://oauth.net/2/">Oauth2</a> 網際程式介面, 讓所有相關成員得以自建倉儲與網際內容管理系統, 之後再分門別類, 根據精密機械工程科學會的任務編組, 利用網際內容管理系統提供相關服務.</p>
<h4 style="padding-left: 30px;">預計成果:</h4>
<ol>
<li>參與 eng.nfu.edu.tw 網域伺服器 (DNS) 與 G Suite 系統管理.</li>
<li>在 Ubuntu 虛擬主機上, 完成以 <a href="https://www.fossil-scm.org">Fossil SCM</a> 架設 pj5073.eng.nfu.edu.tw 精密機械工程科學會網站.</li>
<li>能讓獲得許可之相關人員, 透過 @gm 帳號登入科學會網站, 在各班對應網站上進行 Github 上同步網際內容管理維護或互動討論.</li>
<li>專題報告 pdf 檔案, 能夠在 github.com/mdecourse/pj5073 倉儲中的 pdf 分支, 以 Github Actions 流程發布.</li>
<li>專題簡報可直接在 mde.tw/pj5073/reveal/ 中發布.</li>
</ol>
<h4 style="padding-left: 30px;">組員:</h4>
<p style="padding-left: 60px;">50733105</p>
<p style="padding-left: 60px;">50733144</p>
<p style="padding-left: 60px;">50733146</p>
<p style="padding-left: 60px;">50733152</p>
<h4>教學與研究相關參考內容:</h4>
<p style="padding-left: 30px;"><a href="/downloads/introduction_to_automatic_control_system.pdf">Introduction to Automatic Control System.pdf</a></p>
<p style="padding-left: 30px;">Webots Inverted Pendulum:</p>
<p style="padding-left: 60px;"><a href="https://robotbenchmark.net/benchmark/inverted_pendulum/">https://robotbenchmark.net/benchmark/inverted_pendulum/</a> </p>
<h1>主機設定</h1>
<p>本研究主要利用 Fossil SCM 的網際主機作為主體, 並配置 Python Flask 網際程式管理使用者 Oauth2 登入流程. 目的在建立一個可以為精密機械教學與研究使用的網際內容管理系統.</p>
<p>主機的設定分為 Windows 10 與 Ubuntu 20.04 等兩個部分.</p>
<p>Fossil SCM 的網際主機以 fossil server 指令建立, 可以在近端主機的 port 9000 將資料送給 Stunnel 的 https port 443 協定代理. 使用者從外部可以利用瀏覽器直接以 https 協定連接至主機中的任一個 Fossil SCM 倉儲.</p>
<h4>Windows 10:</h4>
<p style="padding-left: 30px;">在 Windows 10 操作系統中 Multi-repository Fossil SCM 網際伺服器與 Stunnel HTTPS 協定代理的 service 設定, 可以利用 <a href="https://github.com/kirillkovalenko/nssm">https://github.com/kirillkovalenko/nssm</a> 的設定達成.</p>
<h4>Ubuntu 20.04:</h4>
<p style="padding-left: 30px;">在 Ubuntu 操作系統中的 Stunnel 可以利用 exec 與 execargs 設定啟動 Fossil SCM server, 且透過 /etc/default/stunnel4 檔案中的 ENABLED=1 啟動 service (參見 <a href="https://mde.tw/wcmj2021/blog/fossil-scm-on-ubuntu.html">https://mde.tw/wcmj2021/blog/fossil-scm-on-ubuntu.html</a>). 而且在 Ubuntu 中可以利用</p>
<p style="padding-left: 30px;">sudo systemctl start stunnel4.service</p>
<p style="padding-left: 30px;">啟動 <a href="https://www.stunnel.org/">stunnel</a>.</p>
<p style="padding-left: 30px;">sudo systemctl stop stunnel4.service</p>
<p style="padding-left: 30px;">關閉 <a href="https://www.stunnel.org/">stunnel</a>, 或利用:</p>
<p style="padding-left: 30px;">sudo systemctl restart stunnel4.service</p>
<p style="padding-left: 30px;">重新啟動 <a href="https://www.stunnel.org/">stunnel</a>.</p>
<p></p>
<p></p>
<p></p>
<h2>Windows 10</h2>
<p>以虛擬主機 pj2022.kmol.info 的設定為例:</p>
<p>設定過程所需要的檔案: <a href="https://pj2022.kmol.info/pj2022/chat-download/1/pj2022_files.7z">https://pj2022.kmol.info/pj2022/chat-download/1/pj2022_files.7z</a> (登入後下載), 其中包括 nssm.exe, procexp64.exe, fossil.exe, stunnel 目錄等.</p>
<p>要採 Fossil SCM 與 Stunnel 設定 <a href="https://pj2022.kmol.info">https://pj2022.kmol.info</a> 共有兩個 nssm service 必須建立:</p>
<p style="padding-left: 30px;">nssm install fossil_multi</p>
<p style="padding-left: 30px;">nssm install stunnel_fossil_flask</p>
<p>但是在建立這兩個 Windows 10 服務之前必須先使用 command 執行 fossil.exe 與 stunnel.exe, 確定所使用的設定參數正確後, 再將正確的參數用於 nssm 所建立的服務.</p>
<p>Fossil SCM server 指令說明: <a href="https://fossil-scm.org/home/help/server">https://fossil-scm.org/home/help/server</a></p>
<p>Stunnel 設定說明: <a href="https://www.stunnel.org/docs.html">https://www.stunnel.org/docs.html</a></p>
<h4>Fossil SCM server 設定:</h4>
<p style="padding-left: 30px;">首先在 c:\pj2022 目錄中建立 repo 目錄, 之後的 Fossil SCM 倉儲都將放入此目錄.</p>
<p style="padding-left: 30px;">cd 到 c:\pj2022\repo, 並執行 <a href="https://www.fossil-scm.org/home/help?cmd=init">fossil.exe init</a> 建立 pj2022.fossil 倉儲</p>
<p style="padding-left: 60px;">c:\pj2022\repo&gt;c:\pj2022\fossil.exe init pj2022.fossil</p>
<p style="padding-left: 30px;">利用 <a href="https://www.fossil-scm.org/home/help?cmd=user">fossil.exe user password</a> 更改 pj2022.fossil 的管理者密碼.</p>
<p style="padding-left: 60px;">c:\pj2022\repo&gt;c:\pj2022\fossil.exe user password username userpassword -R pj2022.fossil</p>
<p style="padding-left: 30px;">接著以命令列設定 port 9000 的 Fossil SCM 網際主機. 設定的指令為:</p>
<p style="padding-left: 60px;">c:\pj2022\fossil.exe server c:\pj2022\repo --port 9000 --notfound pj2022.fossil</p>
<p style="padding-left: 30px;">啟動時 Windows 10 將會帶出防火牆, 因為 fossil server 僅需要在內部網路運作, 可以無需開啟外部防火牆連線許可. 這時應該可以透過瀏覽器以 <a href="http://localhost:9000">http://localhost:9000</a> 連線到 pj2022.fossil 網際倉儲.</p>
<p style="padding-left: 30px;">接下來因為 fossil.exe 必須採用 https 內容與 stunnel 互動. 因此與 stunnel https 結合的指令必須加上 --https, 也就是:</p>
<p style="padding-left: 60px;">c:\pj2022\fossil.exe server c:\pj2022\repo --port 9000 --https --notfound pj2022.fossil</p>
<p style="padding-left: 30px;">但是啟動後因為尚未結合 stunnel https, 因此上列指令執行後, <a href="http://localhost:9000">http://localhost:9000</a> 與 <a href="https://localhost:9000">https://localhost:9000</a> 都無法連線 (因為 fossil 指令納入 --https 的緣故), 必須結合 stunnel config 目錄中的 stunnel.conf 設定:</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">; TLS front-end to a web server
[https]
accept  = pj2022.kmol.info:443
connect = 9000
cert = localhost.crt
key = localhost.key
TIMEOUTclose = 0</pre>
<p>並且以 c:\pj2022\stunnel.exe 指令啟動, 並無需指定參數 config/stunnel.conf, stunnel.exe 執行時會自動以 config/stunnel.conf 作為設定參數, 此時執行 stunnel.exe Windows 10 也會跳出防火牆設定, 必須允許外部網路連線, 使用者才可以透過 <a href="https://pj2022.kmol.info">https://pj2022.kmol.info</a> 連接至 Fossil SCM 網際 pj2022.fossil 倉儲.</p>
<p>一旦上述採指令執行成功後, 就可以分別以 ctrl +c 取消 fossi 指令執行後, 並且利用 Process Explorer kill stunnel 執行後, 以 nssm 設定：</p>
<p>nssm install fossil_multi 與 nssm install stunnel_fossil_flask 新增所需 Windows 服務.</p>
<p>其中 fossil_multi 服務的指令為 c:\pj2022\fossil.exe, 啟動目錄為 c:\pj2022\, 而啟動參數則為 server c:\pj2022\repo --port 9000 --https --notfound pj2022.fossil</p>
<p>而 stunnel_fossil_flask 服務的指令為 c:\pj2022\stunnel.exe, 啟動目錄為 c:\pj2022\, 啟動參數無需設定, stunnel.exe 會自動取用 config/stunnel.conf 設定.</p>
<p>之後便可以分別啟動 fossil_multi 與 stunnel_fossil_flask 等兩個服務, 查看是否能夠透過 self-signed 數位簽章進行 <a href="https://pj2022.kmol.info">https://pj2022.kmol.info</a> 連線.</p>
<h3>Win 網站簽章</h3>
<h4>Letsencrypt</h4>
<p>由於先前利用 Stunnel 啟動的 https 所使用的 localhost.crt 與 localhost.key 為 self-signed, 使用者在連線至 <a href="https://pj2022.kmol.info">https://pj2022.kmol.info</a> 時必須接受此一數位簽章的 public key, 瀏覽器與伺服器之間才能進行資料編碼傳送.</p>
<p>若能透過 Let's Encrypt 網站所提供的第三方公證數位簽章, 將經過對網站符號名稱公開認證的數位簽章檔案提供給 Stunnel, 此簽章的 public key 就會存在公開的 key server 上, 使用者瀏覽 <a href="https://pj2022.kmol.info">https://pj2022.kmol.info</a> 時就可以直接從 public key server 取得 domain name 編碼用的資料, 進而直接以 https 協定連線.</p>
<p>以下即要說明如何透過 <a href="https://certbot.eff.org/">https://certbot.eff.org/</a> 申請網站符號名稱的正式 https 數位簽章.</p>
<h4>在 Windows 10 安裝 Nginx: </h4>
<p style="padding-left: 30px;"><a href="https://nginx.org/en/docs/windows.html">https://nginx.org/en/docs/windows.html</a></p>
<p>透過 <a href="https://certbot.eff.org/lets-encrypt/windows-nginx">https://certbot.eff.org/lets-encrypt/windows-nginx</a> 所提供的流程申請數位簽章.</p>
<p>由於先安裝 Nginx 全球資訊網伺服器之後, 再安裝 certbot 套件後, 就可以直接透過 www 伺服器驗證網站的符號名稱, 因此取得公證數位簽章的第一步是安裝 Nginx, 而安裝 Nginx 的另外一個用處是, 之後可以利用 html redirect 的方式, 將 http 連線跳轉到 https.</p>
<p>由於 pj2022.kmol.info 伺服器只有設定 IPv6 網址, 因此在設定 Nginx 的時候, 必須注意是否啟動 listen IPv6 網路協定封包. 其中 listen [::]:80 指的就是接受 IPv6 封包, 而 listen :80 就只能接受 IPv4 封包. 另外就是 server_name 設定為 pj2022.kmo.info, 應該就可以啟動 Nginx, 之後則可以再利用 Nssm 將 Nginx 設為服務啟動.</p>
<p>至於 html redirect 的語法:</p>
<pre class="brush:html;auto-links:false;toolbar:false" contenteditable="false">&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv="refresh" content="0; URL=https://pj2022.kmol.info" /&gt;
&lt;/head&gt;
&lt;/html&gt;</pre>
<p>確定利用 Nginx 所設定的 <a href="http://pj2022.kmol.info">http://pj2022.kmol.info</a> 運作正常後, 就可以安裝 <a href="https://dl.eff.org/certbot-beta-installer-win32.exe">https://dl.eff.org/certbot-beta-installer-win32.exe</a>, 然後在具管理者身份的命令列中執行:</p>
<p style="padding-left: 30px;">certbot certonly --webroot</p>
<p>提供必要資訊後就可以在 c:\certbot 目錄中取得對應的 private key (privkey.pem) 與 public key (fullchain.pem). 之後再將 stunnel.conf 中的 localhost.key 與 localhost.crt 換成公證的數位簽章 keys 如下:</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">; TLS front-end to a web server
[https]
accept  = pj2022.kmol.info:443
connect = 9000
cert = fullchain.pem
key = privkey.pem
TIMEOUTclose = 0</pre>
<p>然後再重新啟動 stunnel_fossil_flask 服務即可正式完成 <a href="https://pj2022.kmol.info">https://pj2022.kmol.info</a> 的設定.</p>
<h3>Win Oauth2</h3>
<p>這裡將要說明如何在 Windows 10 環境下配置 <a href="https://github.com/mdecourse/fossiloauth">https://github.com/mdecourse/fossiloauth</a>. 其中將牽涉如何透過 <a href="https://docs.pylonsproject.org/projects/waitress/en/latest/">waitress</a> 啟動 Flask, 此設定就如同在 Ubuntu 環境中以 <a href="https://uwsgi-docs.readthedocs.io/en/latest/">uwsgi</a> 啟動 Flask 網際程式流程, 目的都是希望能以最大效率執行 Flask 網際程式.</p>
<p>首先必須先將 <a href="https://github.com/mdecourse/fossiloauth">fossiloauth</a> clone 到 c:\pj2022 目錄下.</p>
<p style="padding-left: 30px;">c:\pj2022&gt;git clone <a href="https://github.com/mdecourse/fossiloauth.git">https://github.com/mdecourse/fossiloauth.git</a></p>
<p>然後在 fossiloauth 目錄中建立一個 waitress_server.py 伺服器啟動程式:</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false"># 執行前, 必須要先利用 pip install waitress 安裝 wairess 模組
# 接著從 waitress 導入 serve
from waitress import serve

# 導入 fossiloauth
import fossiloauth

# run fossiloauth.app with production waitress
serve(fossiloauth.app, host='0.0.0.0', port=5000, url_scheme='https')</pre>
<p>接下來的設定必須先登入一個 Gmail 帳號, 然後連結到 <a href="https://console.cloud.google.com">https://console.cloud.google.com</a> 中建立 Oauth2 連線時所需的 credential: <a href="https://console.cloud.google.com/apis/credentials">https://console.cloud.google.com/apis/credentials</a>.</p>
<p>由於目前所需的 Oauth2 認證採用全球資訊網 (Web) 介面, 因此還必須根據網站中的程式架構設定認證用的 uri 連結.</p>
<p>至於 Oauth2 認證希望採 Gmail 帳號, 因此還需至 <a href="https://console.cloud.google.com/apis/library">https://console.cloud.google.com/apis/library</a> 中 enabled Gmail API 的使用權限.</p>
<p>建立 credential 流程如下:</p>
<p>至 <a href="https://console.cloud.google.com/apis/credentials">https://console.cloud.google.com/apis/credentials</a> 建立一個專案.</p>
<p>在專案項下建立一組 web credential, 其中的 Authorised JavaScript origins 允許連線的 URIs 選擇設為:</p>
<p><a href="https://pj2022.kmol.info:8443,">https://pj2022.kmol.info:8443,</a> 而 Authorised redirect URIs 則可設為 <a href="https://pj2022.kmo.info:8443/login/google/">https://pj2022.kmo.info:8443/login/google/</a> 表示要使用 port 8443 作為讓使用者登入 Gmail 帳號認證的埠號.</p>
<p>Credential 設定完成後, 可以 downlad 對應的 json 檔案, 以便將此 credential 的 client id 與 client secret 字串檔案, 存在 fossiloauth 目錄之外 (不可以將 credential json 檔案直接放入倉儲, 因為所推送的倉儲都是完全對外公開), 讓採 <a href="https://github.com/authomatic/authomatic">https://github.com/authomatic/authomatic</a> 的 flaskoauth 能夠正常透過 waitress 啟動執行.</p>
<p>執行 flaskoauth 之前必須透過 pip install authomatic 安裝所需的模組套件.</p>
<p>一旦確認 python waitress_server.py 執行正確後, 就可以再利用 Nssm 以 python.exe 執行參數為 waitress_server.py 的系統服務, 例如:</p>
<p style="padding-left: 30px;">c:\pj2022\nssm install fossiloauth</p>
<p>由於上述 fossiloauth 是在內部網路以 port 5000 透過 waitress 執行, 因此仍必須利用 Stunnel 將內部 port 5000 的資料轉給外部 8443 的 https 協定連線, 在 config/stunnel.conf 中加入:</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">[https]
accept = 8443
connect = 5000
cert = fullchain.pem
key = privkey.pem
TIMEOUTclose = 0</pre>
<p>意即在加入 flaskoauth 程式執行後的 stunnel.conf 將成為:</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">; TLS front-end to a web server
[https]
accept  = pj2022.kmol.info:443
connect = 9000
cert = fullchain.pem
key = privkey.pem
TIMEOUTclose = 0

[https]
accept = 8443
connect = 5000
cert = fullchain.pem
key = privkey.pem
TIMEOUTclose = 0</pre>
<p>也就是內部的 fossil server 在 port 9000 啟動, 但透過 stunnel 接受外部的 port 443 https 連線, 而 flaskoauth 則在內部的 port 5000 以 waitress 啟動, 也是透過 stunnel 接受外部的 port 8443 https 連線.</p>
<h3>Oauth2 原理</h3>
<p>使用 Oauth2 協定讓使用者以 Gmail 帳號登入系統的目的, 在於無需管理使用者的帳號, 便能登入 Fossi SCM 網際系統, 具備使用 chat 與 forum 模組的權限.</p>
<p>實務上使用者登入後, 系統便會自動登出使用者的 Gmail 帳號, 並以 session 儲存使用者的帳號.</p>
<p>若使用者首次從 Oauth2 介面登入 Fossil SCM 網際系統, fossiloauth 網際程式會利用登入時所儲存的帳號資料, 在 Fossil SCM 網際系統 (即內定 repository) 中, 以隨機字串作為密碼, 建立能夠在 chat 與 forum 新增資料權限的帳號. 但該用戶因為無從得知與登入帳號對應的密碼, 因此無法利用該隨機密碼從 Fossill SCM 網際系統登入.</p>
<p>若使用者並非首次從 Oauth2 介面登入 Fossil SCM 網際系統, fossioauth 網際程式則會產生一組隨機字串修改該用戶登入時的對應密碼, 以便讓該用戶能夠利用新的隨機密碼登入, 進而編輯或新增 chat 與 forum 模組中的資料.</p>
<p>至於 fossiloauth 取得使用者登入帳號後, 配合隨機產生的字串作為密碼, 能夠在執行 /forum 函式後, 被 Fossil SCM 網際系統視為已經採特定身份 (可在程式中進行設定) 登入的設計, 則是利用 AJAX 將登入帳號與對應密碼以 post 送至 Fossil SCM 網際主機所建立的 session, 以 redirect 的方式轉址至 Fossil SCM 網際 forum 連結, 讓使用者被系統視為已經登入.</p>
<p>而此一 /forum 的程式設計如下:</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">@app.route('/forum')
@login_required
def forum():
    """Create forum routine"""
    # 從倉儲中取出該帳號對應的密碼
    username, userpass = repo()
    with requests.Session() as s:
        url = 'https://c1.kmol.info/pj2022/login'
        # "u" is the username input name for Fossil login form
        # 'p' is the password input name for Fossil login form
        post_var = {'u': username, 'p': userpass}
        headers = {'X-Requested-With': 'XMLHttpRequest'}
        result = s.post(url, data = post_var, headers = headers)
        cookie = s.cookies.get_dict()
        key = list(cookie.keys())[0]
        value = cookie[key]

        forum = "https://c1.kmol.info/pj2022/forum"
        response = make_response(redirect(forum))
        response.set_cookie(key, value, domain="c1.kmol.info", expires=None, path="C:/tmp")
        # logout from 8443
        logout()
        return response  </pre>
<p></p>
<h3>Nginx</h3>
<p>利用 <a href="https://en.wikipedia.org/wiki/HTTP_301">http 301</a> 設定將 http 連線導向 https 網站.</p>
<h4>301 redirect:</h4>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">server {
    listen       [::]:80 default ipv6only=on;
    server_name  pj5073.cycu.org;
    return       301 https://$server_name$request_uri;
    }</pre>
<h4>Autoindex:</h4>
<p>利用簡單的帳號密碼, 保護 autoindex 目錄:</p>
<p>使用 htpasswd.exe 建立 .htpassword</p>
<p>而 htpasswd.exe 來自 Apache, 可以從 <a href="https://archive.apache.org/dist/httpd/binaries/win32/">https://archive.apache.org/dist/httpd/binaries/win32/</a> 下載 .msi 後, 以 <a href="https://www.legroom.net/software/uniextract">https://www.legroom.net/software/uniextract</a> 轉出安裝後的目錄內容, 其中的 bin 目錄中包含 htpasswd.exe</p>
<p>htpasswd.exe 用法 htpasswd -c .htpasswd account</p>
<p>系統會詢問對應密碼, 然後完成 .htpasswd 檔案的建立.</p>
<p>Nginx 中 nginx.conf 則加入 port 88 網站的設定:</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">        server {
        listen       [::]:88 default ipv6only=on;
        server_name  pj5073.cycu.org;
        root C:/pj5073_data;
        auth_basic "KMOLab Login";
        auth_basic_user_file C:/pj2022/nginx-1.20.1/conf/.htpasswd;
        
        location / {
            autoindex on;
        }</pre>
<p><br/><br/></p><h2>Ubuntu設定</h2>
<h4>fcitx 中文輸入法安裝:</h4>
<p style="padding-left: 30px;">sudo apt install fcitx fcitx-chewing</p>
<p>表示將採用 fcitx 中文輸入法中的酷音輸入套件.</p>
<p>酷音輸入法的使用牽涉3個步驟, 第1步驟就是上方的套件安裝, 而第2步驟就是進入系統設定中的 language support, 將原先內建的 ibus 改為 fcitx, 而第3步驟則是在輸入 configure 時, 加入 chewing 中文輸入法, 並且將原先的切換鍵 space 改為 ctrl+space.</p>
<h4>網路設定:</h4>
<p>Ubuntu 21.10 的網路設定取決於 /etc/netplan/net.yaml 檔案設定, 可先將原先的 .yaml 改名為 net.yaml:</p>
<p style="padding-left: 30px;">sudo mv /etc/netplan/*.yaml /etc/netplan/net.yaml</p>
<h4>Network configuration file:</h4>
<p style="padding-left: 30px;">/etc/netplan/net.yaml</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false"># Let NetworkManager manage all devices on this system
network:
  ethernets:
    enp0s3:
      dhcp4: false 
      addresses:
        #- ipv4_address/24
        - ipv6_address/64 
      #gateway4:  ipv4_gateway.254
      gateway6: ipv6_gateway::254
      nameservers:
        addresses:
          - 2001:b000:168::1
  version: 2
  #renderer: NetworkManager</pre>
<h4>每次修改為 /etc/netlan/net.yaml 後必須重新載入設定內容:</h4>
<p style="padding-left: 30px;">sudo netplan apply</p>
<p>在 Ubuntu 操作系統安裝 Fossil SCM server 只需先確認 fossil 的執行位置並且安裝設定 stunnel 即可.</p>
<h4>安裝 stunnel:</h4>
<p style="padding-left: 30px;">sudo apt update</p>
<p style="padding-left: 30px;">sudo apt install stunnel4 -y</p>
<h4>安裝 fossil:</h4>
<p style="padding-left: 30px;">sudo apt install fossil</p>
<h4>環境變數與開機啟動設定:</h4>
<h4 style="padding-left: 30px;">/etc/environment 設定:</h4>
<p style="padding-left: 60px;">HTTPS=on</p>
<h4 style="padding-left: 30px;">/etc/default/stunnel4 檔案設定:</h4>
<p style="padding-left: 60px;">ENABLED=1</p>
<h4>建立 localhost.key 與 localhost.crt:</h4>
<p style="padding-left: 30px;">sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout localhost.key -out localhost.crt</p>
<h4>利用 Stunnel 的 exec 與 execargs 執行 fossil command:</h4>
<p>請注意, 在 Windows 設定 Fossil SCM server 使用 <a href="https://fossil-scm.org/home/help/server">fossil server</a> 指令, 而在 Ubuntu 則使用 <a href="https://fossil-scm.org/home/help/http">fossil http</a>.</p>
<p>fossil server (Windows 使用) 與 fossil http (Ubuntu 直接以 stunnel execargs 執行) 的差異:</p>
<p>fossil server:</p>
<p style="padding-left: 30px;">啟動後將以 <span style="background-color: #ffff99;">http 協定</span>在設定的 port 上回應資料.</p>
<p>fossil http:</p>
<p style="padding-left: 30px;">啟動後將在 <span style="background-color: #ffff99;">stdin</span> 接受單一 http 連線請求, 回應網頁將以 <span style="background-color: #ffff99;">stdout</span> 方式傳送.</p>
<p>設定檔案 /etc/stunnel/stunnel.conf:</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">[https]
accept = :5443
accept = :::5443
cert = /etc/stunnel/localhost.crt
key = /etc/stunnel/localhost.key
exec = /usr/bin/fossil
execargs = /usr/bin/fossil http /home/wcm2021/repository/ --https --nojail --notfound cmstemplate</pre>
<p>表示利用 stunnel 執行 fossil 指令, 並且透過 http 協定啟動 位於 /home/wcm2021/repository 目錄下的倉儲壓縮檔案, 且附加採用 https 與 nojail 模式啟動.</p>
<p>其中 --nojail 目的在 drop the root privilege but do not enter the chroot jail, 其後的 --notfound 表示若沒有特別在 URL 中列出所要擷取的 .fossil 檔案 (指位於 /home/wcm2021/repository/ 目錄下), 則採用 cmstemplate.fossil</p>
<p>重新啟用 stunnel:</p>
<p style="padding-left: 30px;">sudo /etc/init.d/stunnel4 restart</p><h3>Ubuntu 簽章</h3>
<p>連線至 <a href="https://certbot.eff.org/lets-encrypt/ubuntufocal-nginx">https://certbot.eff.org/lets-encrypt/ubuntufocal-nginx</a></p>
<p>snap 上網之前, 必須檢查 /etc/environment 中的代理主機設定.</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin"
HTTPS=on
http_proxy=http://[2001:288:6004:17::Proxy_ip]:3128
https_proxy=http://[2001:288:6004:17::Proxy_ip]:3128</pre>
<p>其中的 HTTPS=on 是針對 Stunnel, 而 http_proxy 與 https_proxy 則可為 snap 安裝套件時採用.</p>
<p>首先確定 snapd 使用最新版本:</p>
<p style="padding-left: 30px;">sudo snap install core; sudo snap refresh core</p>
<p>接著安裝 certbot:</p>
<p style="padding-left: 30px;">sudo snap install --classic certbot</p>
<p style="padding-left: 30px;">sudo ln -s /snap/bin/certbot /usr/bin/certbot</p>
<p>只取 certificate:</p>
<p style="padding-left: 30px;">sudo certbot certonly --nginx</p>
<p>一旦執行完成, 即可取得與 domain name 對應的 certificates:</p>
<pre class="brush:html;auto-links:false;toolbar:false" contenteditable="false">Successfully received certificate.
Certificate is saved at: /etc/letsencrypt/live/domain_name/fullchain.pem
Key is saved at:         /etc/letsencrypt/live/domain_name/privkey.pem</pre>
<p>之後利用 sudo cp -r /etc/letsencrypt/archive /home/wcm2021/, 然後利用 sudo chown -R wcm2021:wcm2021 /home/wcm2021/archive, 接著將 archive 目錄中的 fullchain.pem 與 privkey.pem 複製至 /etc/stunnel/, 然後編輯 stunnel.conf, 利用 fullchain.pem 取代 localhost.crt, 利用 privkey.pem 取代 localhost.key, 重新啟動 stunnel:</p>
<p>sudo /etc/init.d/stunnel4 restart</p>
<p>之後 Stunnel (也就是 Fossil SCM server) 應該就可以正確使用 https 協定.</p>
<p>接著編輯 /etc/nginx/sites-available/default, 將 localhost.crt 換為 fullchain.pem, localhost.key 換為 privkey.pem, 然後以 /etc/init.d/nginx restart 重新啟動 nginx, 之後的 Flask 網際程式應該就能以正式的 https 連線.</p>
<p>測試自動 renew certificate:</p>
<p style="padding-left: 30px;">sudo certbot renew --dry-run</p><h3>配置 uwsgi</h3>
<p>在 Ubuntu 環境中可透過 uwsgi 執行 Flask 網際程式. 並且利用 Nginx 配置 Let's Encrypt 數位簽章.</p>
<h4>安裝 Nginx WWW 伺服器:</h4>
<p style="padding-left: 30px;">在 Ubuntu 安裝 nginx 伺服器:</p>
<p style="padding-left: 60px;">sudo apt install nginx</p>
<p style="padding-left: 30px;">其中必須注意的是, apt 將使用 /etc/apt.conf 中所設定的 proxy 進行網路連線.</p>
<p style="padding-left: 30px;">apt.conf 設定格式為:</p>
<p style="padding-left: 60px;">Acquire::http::Proxy "http://[2001:288:6004:17::proxy_ip]:3128";</p>
<p style="padding-left: 60px;">Acquire::https::Proxy "http://[2001:288:6004:17::proxy_ip]:3128";</p>
<h4>/etc/nginx/sites-available/default 參考檔案:</h4>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">server {
    listen 80;
    listen [::]:80;
    root /home/wcm2021/newcms;
    index index.html;
  
    location /static {
        alias /home/wcm2021/newcms/cmsimde/static/;
    }
  
    location /downloads {
        alias /home/wcm2021/newcms/downloads/;
    }
  
    location /images {
        alias /home/wcm2021/newcms/images/;
    }
  
    location / {
            try_files $uri $uri/ =404;
    } 
      
    location /blog {
        alias /home/wcm2021/cmsimfly/blog/;
    }
  
    location /reveal {
        alias /home/wcm2021/cmsimfly/reveal/;
    }
}
  
server {
    listen 443 ssl;
    #listen [::]:443 ssl ipv6only=on;
   
    location /static {
        alias /home/wcm2021/cmsimfly/static/;
    }
   
    location / {
        include uwsgi_params;
        uwsgi_pass  127.0.0.1:8080;
    }
   
    #server_name ipv4_ip; 
    #ssl on;
    ssl_certificate /etc/stunnel/localhost.crt;
    ssl_certificate_key /etc/stunnel/localhost.key;
    ssl_session_timeout 5m;
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers "HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES";
    ssl_prefer_server_ciphers on;
    try_files $uri $uri/ =404;
}
   
server {
    #listen 89 default_server;
    #listen [::]:89 default_server ipv6only=on;
   
    listen 8943 ssl;
    #listen [::]:8943 ssl ipv6only=on;
   
    location /static {
        alias /home/wcm2021/cmsimfly2/static/;
    }
   
    location / {
        include uwsgi_params;
        uwsgi_pass  127.0.0.1:8082;
    }
   
    #server_name ipv4_ip;
    #ssl on;
    ssl_certificate /etc/stunnel/localhost.crt;
    ssl_certificate_key /etc/stunnel/localhost.key;
    ssl_session_timeout 5m;
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers "HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES";
    ssl_prefer_server_ciphers on;
    try_files $uri $uri/ =404;
}
  
server {
    #listen 88 default_server;
    #listen [::]:88 default_server ipv6only=on;
   
    listen 8843 ssl;
    #listen [::]:8843 ssl ipv6only=on;
   
    location /static {
        alias /home/wcm2021/newcms/cmsimde/static/;
    }
   
    location / {
        include uwsgi_params;
        uwsgi_pass  127.0.0.1:8081;
    }
   
    #server_name ipv4_ip;
    #ssl on;
    ssl_certificate /etc/stunnel/localhost.crt;
    ssl_certificate_key /etc/stunnel/localhost.key;
    ssl_session_timeout 5m;
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers "HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES";
    ssl_prefer_server_ciphers on;
    try_files $uri $uri/ =404;
}</pre>
<h4>uwsgi 環境準備:</h4>
<p style="padding-left: 30px;">sudo apt install uwsgi uwsgi-plugin-python3</p>
<p style="padding-left: 30px;">sudo pip3 install uwsgi</p>
<p style="padding-left: 30px;">編輯的設定檔案為 uwsgi_ini 目錄中的各個 .ini 設定檔案.</p>
<h4>uwsgi.ini 參考檔案:</h4>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">[uwsgi]
socket = 127.0.0.1:8080
uid = kmol2019
gid = kmol2019
plugins-dir = /usr/lib/uwsgi/plugins/
plugin = python3
master = true
logto = /var/log/uwsgi/emperor.log
logfile-chown = kmol2019:kmol2019
processes = 4
threads = 2
chdir = /home/kmol2019/cmsimfly
wsgi-file = /home/kmol2019/cmsimfly/wsgi.py</pre>
<h4>python3 環境準備:</h4>
<p style="padding-left: 30px;">安裝 pip3:</p>
<p style="padding-left: 30px;">sudo apt install python3-pip</p>
<h4>安裝 CMSiMDE 所需模組:</h4>
<p style="padding-left: 30px;">sudo pip3 install flask bs4 lxml flask_cors pelican markdown leo pyopenssl</p>
<h4>CMSiMDE 的設定:</h4>
<p style="padding-left: 30px;">init.py 中必須將 uwsgi = False 改為 True, 因為準備採用 uwsgi 模式啟動 CMSiMDE</p>
<h4>apt proxy 設定檔案:</h4>
<p style="padding-left: 30px;">啟動 uwsgi 指令, 將會逐一啟動 wsgi_ini 目錄中個別 .ini 檔案:</p>
<p style="padding-left: 30px;">sudo /usr/bin/uwsgi --emperor /home/kmol2019/wsgi_ini</p>
<p>最後則設定 Ubuntu 系統服務, 用來啟動 uwsgi:</p>
<p>/etc/systemd/system 的 cmsimde.service 服務啟動檔案內容:</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">[Unit]
Description=uWSGI to serve CMSiMDE
After=network.target
  
[Service]
User=kmol2019
Group=kmol2019
WorkingDirectory=/home/kmol2019/uwsgi_ini
ExecStart=/usr/local/bin/uwsgi --emperor /home/kmol2019/uwsgi_ini
  
[Install]
WantedBy=multi-user.target</pre>
<p>接著將 cmsimde 服務設為隨系統開機啟動:</p>
<p style="padding-left: 30px;">sudo systemctl enable cmsimde</p>
<p>若要取消 cmsimde 服務隨系統開機啟動:</p>
<p style="padding-left: 30px;">sudo systemctl disable cmsimde</p>
<p>手動啟動 cmsimde.service 服務</p>
<p style="padding-left: 30px;">sudo systemctl start cmsimde</p>
<p>手動停止 cmsimde.service 服務</p>
<p style="padding-left: 30px;">sudo systemctl stop cmsimde</p>
<p>最後, 在 Ubuntu 虛擬主機中設定 Fossil SCM:</p>
<p>安裝 fossil:</p>
<p style="padding-left: 30px;">sudo apt install fossil</p>
<p>查 fossil 版本:</p>
<p style="padding-left: 30px;">fossil version</p>
<p>接下來為了要在 https 的模式下使用 Fossil SCM 伺服器, 因此必須安裝配置 stunnel:</p>
<p style="padding-left: 30px;">sudo apt install stunnel</p>
<p>修改 /etc/environment, 加入:</p>
<p style="padding-left: 30px;">HTTPS=on</p>
<p>修改 /etc/default/stunnel4, 修改 ENABLED=1</p>
<p>假如此時 /etc/stunnel 目錄下尚無 localhost.crt 與 localhost.key, 可以利用下列指令建立:</p>
<p>建立 localhost.key 與 localhost.crt:</p>
<p style="padding-left: 30px;">sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout localhost.key -out localhost.crt</p>
<p>接著設定 /etc/stunnel/stunnel.conf 如下:</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">[https]
accept = kmol2019:5443
# 只先啟用 ipv4
#accept = :::443
cert = /etc/stunnel/localhost.crt
key = /etc/stunnel/localhost.key
exec = /usr/bin/fossil
execargs = /usr/bin/fossil http /home/kmol2019/repository/ --https --nojail --notfound kmol2019</pre>
<p>表示利用 stunnel 執行 fossil 指令, 並且透過 http 協定啟動 位於 /home/kmol2019/repository 目錄下的倉儲壓縮檔案, 且附加採用 https 與 nojail 模式啟動.</p>
<p>其中 --nojail 目的在 drop the root privilege but do not enter the chroot jail, 其後的 --notfound 表示若沒有特別在 URL 中列出所要擷取的 .fossil 檔案 (指位於 /home/kmol2019/repository/ 目錄下), 則採用 kmol2019.fossil</p>
<p>重新啟用 stunnel:</p>
<p style="padding-left: 30px;">sudo /etc/init.d/stunnel4 restart</p>
<h3>xrdp</h3>
<p>在 Ubuntu 操作系統上安裝 xrdp (X-windows remote desktop) 伺服器的目的是讓使用者可以透過遠端桌面 client, 以圖型介面的方式連驗到 Ubuntu 伺服器. 這裡選擇在 Ubuntu server 系統上安裝主要的 ubuntu-desktop 套件, 指令為:</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">sudo apt-get install --no-install-recommends ubuntu-desktop</pre>
<p>安裝容量大約 1GB.</p>
<p>安裝後, 重新開機就可以透過圖形界面登入操作.</p>
<p>接著安裝 xrdp 伺服器程式:</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">sudo apt install xrdp</pre>
<p>接著必須將 xrdp 帳號納入 ssl-cert 群組, 才能夠擁有讀取內定 /etc/ssl/private/ssl-cert-snakeoil.key 認證簽章檔案.</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">sudo adduser xrdp ssl-cert</pre>
<p>xrdp 伺服器環境設定完成後必須重新啟動服務:</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">sudo systemctl restart xrdp</pre>
<p>完成後還必須設法讓特定網段電腦能夠通過 ufw 防火牆, 連線到 port 3389.</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">ufw allow from 2001:xxx:xxxx:17::/32 to any port 3389</pre>
<p>表示只允許 2001:xxx:xxxx:17:: 網段的電腦可以透過 rdp client 連線到此一伺服器.</p>
<h4 class="brush:bash;">參考資料:</h4>
<ol>
<li><a href="https://snippetinfo.net/mobile/media/800">https://snippetinfo.net/mobile/media/800</a></li>
<li><a href="https://linuxize.com/post/how-to-install-xrdp-on-ubuntu-20-04/">https://linuxize.com/post/how-to-install-xrdp-on-ubuntu-20-04/</a> <br/><br/></li>
</ol><h1>fossiloauth</h1>
<p>以下在整理 fossiloauth 相關設定參數, 擬改寫時將所有設定存入 config.py, 然後導入主要程式中運用.</p>
<p>當配置 fossiloauth 網際程式時, 需要:</p>
<p>Google oauth2 client key and secret 檔案 (必須放在倉儲以外的目錄):</p>
<p>例如:</p>
<p style="padding-left: 30px;">第一列: 214-this_is_key.apps.googleusercontent.com</p>
<p style="padding-left: 30px;">第二例: this_is_secret-pktheSAqSunfu</p>
<p>Fossil SCM server domain name: 例如: c1.kmol.info</p>
<p>Fossil SCM server repository name: 例如: pj2022</p>
<p>從 domain name 與 repository name 得知:</p>
<p>Login 連結: <a href="https://c1.kmol.info/pj2022/login">https://c1.kmol.info/pj2022/login</a></p>
<p>Forum 連結: <a href="https://c1.kmol.info/pj2022/forum">https://c1.kmol.info/pj2022/forum</a></p>
<p>自建 Fossil SCM 帳號權限: 例如: 'bfjk234C'</p>
<p>自建 Fossil SCM 倉儲存放位置: 例如: path = "c:\pj2022\repo"</p>
<p>fossiloauth 網際程式執行 URL: 例如: <a href="https://c1.kmol.info:8443">https://c1.kmol.info:8443</a>, 以及執行 forum 連結 <a href="https://c1.kmol.info:8443/forum">https://c1.kmol.info:8443/forum</a> (目的在透過 AJAX 將登入帳號與密碼送至 Server, 以便取得登入 Fossil SCM server 的 session).</p>
<p>以上這些設定應該要寫入 config.py</p>
<p>因為要改寫 fossiloauth, 因此在 Ubuntu 安裝 Leo:</p>
<p style="padding-left: 30px;">sudo pip3 install leo</p>
<p>安裝結束後, 以 leo&amp; 啟動.</p>
<h2>foauth_config</h2>
<h4>config.py content:</h4>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">import authomatic
from authomatic.providers import oauth2

# read client_id and client_secret from safe place other than put into script
# use scrum4 At mde to get credential data
# credential url: https://console.cloud.google.com
keyFile = open('./../scrum2_client_secret.txt', 'r')
with open('./../scrum2_client_secret.txt', 'r') as f:
    key = f.read().splitlines()

CONFIG = {
        'google': {
            'class_': oauth2.Google,
            'consumer_key': key[0],
            'consumer_secret': key[1],
            'scope': oauth2.Google.user_info_scope
        }
    }

domain_name = "c2.kmol.info"
default_repo = "pj2022"
repo_caps = "bfjk234C"
# for Windows 
#repo_path = "c:/pj2022/repo/"
# for Ubuntu
repo_path = "/home/wcm2021/repository/"
fossil_port = "5443"
flask_port = "8443"
uwsgi = True

# derived
default_repo_path = repo_path+default_repo+".fossil"
flask_url = "https://"+domain_name+":"+flask_port
flask_forum = "https://"+domain_name+":"+flask_port+"/forum"
login_url = "https://"+domain_name+":"+fossil_port+"/"+default_repo+"/login"
forum_url = "https://"+domain_name+":"+fossil_port+"/"+default_repo+"/forum"
CALLBACK_URL = flask_forum</pre>
<h4>wsgi.py</h4>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">import fossiloauth
import config

uwsgi = config.uwsgi

domain_name = config.domain_name
port = config.flask_port

application = fossiloauth.app

if __name__ == "__main__":
    
    if uwsgi:
        application = fossiloauth.app
    else:
        domain_name = "127.0.0.1"
        fossiloauth.app.run(host=domain_name, port=port, ssl_context='adhoc')
        </pre>
<h4>templates/login.html:</h4>
<pre class="brush:html;auto-links:false;toolbar:false" contenteditable="false">## index.html
&lt;%inherit file="base.html"/&gt;

&lt;%block name="header"&gt;
    &lt;!-- this is some header content --&gt;
&lt;/%block&gt;

&lt;!-- this is the body content. --&gt;

    &lt;a href="/index"&gt;Home&lt;/a&gt;
    
    ## Check for errors.
    % if result.error:
        &lt;h2&gt;Damn that error: ${ result.error.message }&lt;/h2&gt;
    % endif
    
    ## Welcome the user.
    % if result.user:
        &lt;h1&gt;Hi ${result.user.name}&lt;/h1&gt;
        &lt;h2&gt;Your id is: ${ result.user.id }&lt;/h2&gt;
        &lt;h2&gt;Your email is: ${ result.user.email }&lt;/h2&gt;
    % endif

&lt;!-- after GMail login process, use javascript to logout GMail account, and redirect to callbackurl  --&gt;
&lt;!-- use jinia2 template format --&gt;
&lt;script type="text/javascript"&gt;
window.location="https://www.google.com/accounts/Logout?continue=https://appengine.google.com/_ah/logout?continue=${CALLBACK_URL}";
&lt;/script&gt;</pre>
<h4>/etc/nginx/sites-available/default</h4>
<p>start nginx: sudo /etc/init.d/nginx start</p>
<p>stop nginx: sudo /etc/init.d/nginx stop</p>
<p>restart nginx: sudo /etc/init.d/nginx restart</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">server {
	listen 80 default_server;
	listen [::]:80 default_server;

        root /home/wcm2021/github/cmstemplate/;

	index index.html index.htm index.nginx-debian.html;

	server_name _;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ =404;
	}

}

# 443 with uwsgi 
server {
    listen 443 ssl default_server;
    listen [::]:443 ssl default_server;
   
    location / {
        include uwsgi_params;
        uwsgi_pass  127.0.0.1:8080;
    }
   
    ssl_certificate /etc/stunnel/fullchain.pem;
    ssl_certificate_key /etc/stunnel/privkey.pem;
    ssl_session_timeout 5m;
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers "HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES";
    ssl_prefer_server_ciphers on;
    try_files $uri $uri/ =404;
}

# 8443 with uwsgi for fossiloauth
server {
    listen 8443 ssl default_server;
    listen [::]:8443 ssl default_server;
   
    location / {
        include uwsgi_params;
        uwsgi_pass  127.0.0.1:8081;
    }
   
    ssl_certificate /etc/stunnel/fullchain.pem;
    ssl_certificate_key /etc/stunnel/privkey.pem;
    ssl_session_timeout 5m;
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers "HIGH:!aNULL:!MD5 or HIGH:!aNULL:!MD5:!3DES";
    ssl_prefer_server_ciphers on;
    try_files $uri $uri/ =404;
}</pre>
<h4>/home/wcm2021/uwsgi_ini/flask_oauth.ini</h4>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">[uwsgi]
socket = :8081
uid = wcm2021
gid = wcm2021
plugins-dir = /usr/lib/uwsgi/plugins/
plugin = python3
master = true
process = 4
threads = 2
chdir = /home/wcm2021/fossiloauth
wsgi-file = /home/wcm2021/fossiloauth/wsgi.py</pre>
<h4>/home/wcm2021/uwsgi_ini/uwsgi.ini</h4>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">[uwsgi]
socket = :8080
uid = wcm2021
gid = wcm2021
plugins-dir = /usr/lib/uwsgi/plugins/
plugin = python3
master = true
process = 4
threads = 2
chdir = /home/wcm2021/github/cmstemplate
wsgi-file = /home/wcm2021/github/cmstemplate/cmsimde/wsgi.py</pre>
<h4>/etc/systemd/system/cmsimde.service</h4>
<p>列出 Ubuntu 中目前已經啟動的系統服務, 可以在終端機視窗中輸入:</p>
<p style="padding-left: 30px;">service --status-all</p>
<p>enable cmsimde.service: sudo systemctl enable cmsimde</p>
<p>disable cmsimde.service: sudo systemctl disable cmsimde</p>
<p>start cmsimde.service: sudo systemctl start cmsimde</p>
<p>stop cmsimde.service: sudo systemctl stop cmsimde</p>
<p>restart cmsimde.service: sudo systemctl restart cmsimde</p>
<pre class="brush:js;auto-links:false;toolbar:false" contenteditable="false">[Unit]
Description=uWSGI to serve CMSiMDE
After=network.target
   
[Service]
User=wcm2021
Group=wcm2021
WorkingDirectory=/home/wcm2021/uwsgi_ini
ExecStart=/usr/bin/uwsgi --emperor /home/wcm2021/uwsgi_ini
   
[Install]
WantedBy=multi-user.target</pre>
<h4>/etc/stunnel to start with system:</h4>
<p>修改 /etc/default/stunnel4, 修改 ENABLED=1</p>
<p>然後以:</p>
<p style="padding-left: 30px;">sudo /etc/init.d/stunnel4 restart</p>
<p>to restart</p><h1>Reference</h1><h2>Flutter</h2>
<p><a href="https://flutter.dev/">https://flutter.dev/</a></p>
<p><a href="https://drive.google.com/file/d/1-VY9wQOEDeu-_KY4EhqqoyUq8xZMtEG9/view?usp=sharing">下載 kmol_project_2021.7z</a> 可攜程式系統</p>
<p>References:</p>
<p style="padding-left: 30px;"><a href="https://medium.com/analytics-vidhya/deploy-ml-models-using-flask-as-rest-api-and-access-via-flutter-app-7ce63d5c1f3b">https://medium.com/analytics-vidhya/deploy-ml-models-using-flask-as-rest-api-and-access-via-flutter-app-7ce63d5c1f3b</a></p>
<p style="padding-left: 60px;"><a href="https://github.com/SHARONZACHARIA/Deploy-ML-model">https://github.com/SHARONZACHARIA/Deploy-ML-model</a></p>
<p style="padding-left: 30px;"><a href="https://nitishk72.medium.com/flutter-uploading-image-to-server-aec76876b9e1">https://nitishk72.medium.com/flutter-uploading-image-to-server-aec76876b9e1</a></p>
<p style="padding-left: 30px;"><a href="https://stackoverflow.com/questions/51161862/how-to-send-an-image-to-an-api-in-dart-flutter">https://stackoverflow.com/questions/51161862/how-to-send-an-image-to-an-api-in-dart-flutter</a></p>
<p style="padding-left: 30px;"><a href="https://stackoverflow.com/questions/60614857/how-to-post-an-image-as-a-request-with-flask-server-api-in-dart-flutter">https://stackoverflow.com/questions/60614857/how-to-post-an-image-as-a-request-with-flask-server-api-in-dart-flutter</a></p>
<p style="padding-left: 30px;"><a href="https://dev.to/carminezacc/advanced-flutter-networking-part-1-uploading-a-file-to-a-rest-api-from-flutter-using-a-multi-part-form-data-post-request-2ekm">https://dev.to/carminezacc/advanced-flutter-networking-part-1-uploading-a-file-to-a-rest-api-from-flutter-using-a-multi-part-form-data-post-request-2ekm</a></p>
<p style="padding-left: 30px;"><a href="https://flutter.dev/docs/cookbook/networking/send-data">https://flutter.dev/docs/cookbook/networking/send-data</a></p>
<p></p>
<h3>Flutter ref</h3>
<p><a href="/downloads/Flutter完整开发实战详解系列.pdf">Flutter完整开发实战详解系列.pdf</a></p>
<p><a href="https://github.com/apgapg/flutter_physics_concepts">https://github.com/apgapg/flutter_physics_concepts</a></p>
<p><a href="https://rodolfohernan20.blogspot.com/2019/12/upload-files-to-server-with-flutter-web.html">https://rodolfohernan20.blogspot.com/2019/12/upload-files-to-server-with-flutter-web.html</a></p>
<p><a href="https://github.com/tekartik/sqflite">https://github.com/tekartik/sqflite</a></p>
<p><a href="https://stackoverflow.com/questions/54223929/how-to-do-a-database-query-with-sqflite-in-flutter">https://stackoverflow.com/questions/54223929/how-to-do-a-database-query-with-sqflite-in-flutter</a></p>
<p><span style="background-color: #ffff00;"><a href="https://github.com/rxlabz/algrafx" style="background-color: #ffff00;">https://github.com/rxlabz/algrafx</a></span></p>
<p><a href="https://github.com/KarimEbrahemAbdelaziz/drawapp">https://github.com/KarimEbrahemAbdelaziz/drawapp</a></p>
<p><a href="https://github.com/KalleHallden/StudenServicesApp">https://github.com/KalleHallden/StudenServicesApp</a></p>
<p><a href="https://pub.dev/packages/github">https://pub.dev/packages/github</a></p>
<p><a href="https://github.com/flutter/flutter_markdown">https://github.com/flutter/flutter_markdown</a></p>
<p><a href="https://github.com/Baseflow/flutter-geolocator">https://github.com/Baseflow/flutter-geolocator</a></p>
<p><a href="https://github.com/apptreesoftware/flutter_barcode_reader">https://github.com/apptreesoftware/flutter_barcode_reader</a></p>
<p><a href="https://github.com/tekartik/sqflite">https://github.com/tekartik/sqflite</a></p>
<p><a href="https://github.com/matteocrippa/flutter-nfc-reader">https://github.com/matteocrippa/flutter-nfc-reader</a></p>
<p><span style="background-color: #ffff00;"><a href="https://github.com/CarGuo/gsy_github_app_flutter" style="background-color: #ffff00;">https://github.com/CarGuo/gsy_github_app_flutter</a></span></p>
<p><a href="https://github.com/WinkMeter/flutter_socket_io">https://github.com/WinkMeter/flutter_socket_io</a></p>
<p><a href="https://paulhammant.com/2018/08/18/flutter-and-ui-automation/">https://paulhammant.com/2018/08/18/flutter-and-ui-automation/</a></p>
<p>根據 <a href="https://stackoverflow.com/questions/49609889/flutter-doctor-doesnt-work-on-neither-command-prompt-or-powershell-window">https://stackoverflow.com/questions/49609889/flutter-doctor-doesnt-work-on-neither-command-prompt-or-powershell-window</a></p>
<p>在 Windows 10 環境時需要納入 c:\windows\system32 指令路徑搜尋. 而 flutter upgrade 時需要 powershell, 因此可攜程式啟動時, 可以將 Windows 10 的 %path% 放入 start.bat 中 path 設定順序最後一個搜尋路徑.</p>
<p style="padding-left: 30px;"><a href="https://flutter.dev/docs">https://flutter.dev/docs</a></p>
<p style="padding-left: 30px;"><a href="https://medium.com/dartlang/announcing-dart-2-5-super-charged-development-328822024970">https://medium.com/dartlang/announcing-dart-2-5-super-charged-development-328822024970</a></p>
<p style="padding-left: 30px;"><a href="https://medium.com/@adityadroid/60-days-of-flutter-creating-the-app-ea0407b472ae">https://medium.com/@adityadroid/60-days-of-flutter-creating-the-app-ea0407b472ae</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/flutterkit/zerker">https://github.com/flutterkit/zerker</a></p>
<p style="padding-left: 30px;"><a href="https://www.reddit.com/r/FlutterDev/">https://www.reddit.com/r/FlutterDev/</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/flutter/flutter/projects">https://github.com/flutter/flutter/projects</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/flutter/samples">https://github.com/flutter/samples</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/apptreesoftware/flutter_map">https://github.com/apptreesoftware/flutter_map</a></p>
<p style="padding-left: 30px;"><a href="https://pub.dev/packages/p5">https://pub.dev/packages/p5</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/duytq94/flutter-chat-demo">https://github.com/duytq94/flutter-chat-demo</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/srplab/starcore_for_flutter">https://github.com/srplab/starcore_for_flutter</a></p>
<p style="padding-left: 30px;"><a href="https://blog.geekyants.com/building-a-2d-game-in-flutter-a-comprehensive-guide-913f647846bc">https://blog.geekyants.com/building-a-2d-game-in-flutter-a-comprehensive-guide-913f647846bc</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/mdecourse/flutter-galaxy-game">https://github.com/mdecourse/flutter-galaxy-game</a></p>
<p style="padding-left: 30px;"><a href="https://flutterchina.club/docs/">https://flutterchina.club/docs/</a></p>
<p style="padding-left: 30px;">Flutter 實戰: <a href="https://book.flutterchina.club/">https://book.flutterchina.club/</a> (<a href="https://github.com/flutterchina/flutter-in-action">Github</a>)</p>
<p>Flutter 與 Web 架構:</p>
<p style="padding-left: 30px;"><a href="https://medium.com/flutter/hummingbird-building-flutter-for-the-web-e687c2a023a8">https://medium.com/flutter/hummingbird-building-flutter-for-the-web-e687c2a023a8</a></p>
<p>Flutter 升級:</p>
<p style="padding-left: 30px;">flutter upgrade</p>
<p>Flutter 移除 analytics:</p>
<p style="padding-left: 30px;">flutter config --no-analytics</p>
<h4>Flutter Tutorial:</h4>
<p style="padding-left: 30px;"><a href="https://flutter.dev/docs/reference/tutorials">https://flutter.dev/docs/reference/tutorials</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/FilledStacks/flutter-tutorials">https://github.com/FilledStacks/flutter-tutorials</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/CarGuo/GSYGithubAppFlutter">https://github.com/CarGuo/GSYGithubAppFlutter</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/trending/dart">https://github.com/trending/dart</a></p>
<h4>Rendering:</h4>
<p style="padding-left: 30px;"><a href="https://api.flutter.dev/flutter/rendering/CustomPainter-class.html">https://api.flutter.dev/flutter/rendering/CustomPainter-class.html</a></p>
<p><iframe allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen" frameborder="0" height="315" src="https://www.youtube.com/embed/G7ZmQEXqmGA" width="560"></iframe></p>
<h4>Signature Pad:</h4>
<p style="padding-left: 30px;"><a href="https://pub.dev/packages/signature_pad">https://pub.dev/packages/signature_pad</a></p>
<p>第一步:</p>
<p style="padding-left: 30px;">在校園網路或以 VPN 或設定代理主機, 下載 <a href="https://link.springer.com/book/10.1007/978-1-4842-4972-7">2019 Pratical Flutter 電子書</a>.</p>
<p style="padding-left: 30px;">登入 @gm 電子郵箱後, 下載可放入 USB 隨身碟運作的可攜系統:</p>
<p style="padding-left: 60px;"><a href="https://drive.google.com/file/d/1-VY9wQOEDeu-_KY4EhqqoyUq8xZMtEG9/view?usp=sharing">下載 kmol_project_2021.7z</a> 可攜程式系統</p>
<p>第二步:</p>
<p style="padding-left: 30px;">解開 kmol_project_2021.7z, 並在執行手機程式開發的 Windows 10 64 位元電腦上安裝 <a href="https://www.bluestacks.com/">https://www.bluestacks.com</a></p>
<p style="padding-left: 30px;">之後, 我們可以直接啟動 Flutter 隨身系統後, 利用電腦上的 Bluestacks 執行手機程式.</p>
<p>第三步:</p>
<p style="padding-left: 30px;">啟動 Flutter 可攜系統後, 可以直接在命令列中輸入 code, 啟動 Visual Studio Code 程式編輯系統.</p>
<p>第四步:</p>
<p style="padding-left: 30px;">執行第二步在操作系統中所安裝的 Bluestacks, 開啟後, 在命令列中以 adb connect localhost:5555, 以便之後將 Visual Studio Code 中的 Flutter 程式結果呈現在 Bluestacks 虛擬手機畫面中.</p>
<p style="padding-left: 30px;">由於 Bluestacks 採用與 Virualbox 相同的虛擬主機模式, 適合在 CPU 等級較低的電腦上執行開發, 也可以在 Visual Studio Code 中按下 Ctrl + Shift + P, 然後輸入 flutter, 除了可以新建 Flutter 專案外, 也可以透過 Android Virtual Devices 指令, 建立 emulator, 並將編譯完成的手機程式結果, 呈現在對應的 emulator 中.</p>
<p style="padding-left: 30px;">當然, 若使用者已經安裝並設置<a href="https://developer.android.com/studio/run/win-usb">https://developer.android.com/studio/run/win-usb</a>, 也可以直接利用 USB 連接實體 Android 手機進行程式開發測試.</p>
<h4>參考資料</h4>
<p style="padding-left: 30px;"><a href="https://flutterbyexample.com/">https://flutterbyexample.com/</a></p>
<p style="padding-left: 30px;"><a href="https://proandroiddev.com/mythbuster-10-rumors-about-flutter-why-its-not-worse-than-android-kotlin-f1a1acbe587d">https://proandroiddev.com/mythbuster-10-rumors-about-flutter-why-its-not-worse-than-android-kotlin-f1a1acbe587d</a></p>
<h4>專案範例</h4>
<p style="padding-left: 30px;"><a href="https://github.com/alibaba/flutter-go">https://github.com/alibaba/flutter-go</a></p>
<p style="padding-left: 30px;"><a href="https://medium.com/flutter-community/flutter-firebase-realtime-database-crud-operations-using-provider-c242a01f6a10">https://medium.com/flutter-community/flutter-firebase-realtime-database-crud-operations-using-provider-c242a01f6a10</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/flutter-ui-challenges/flutter_web_challenge_googlemaps">https://github.com/flutter-ui-challenges/flutter_web_challenge_googlemaps</a></p>
<p style="padding-left: 30px;"><a href="https://medium.com/flutter-community/writing-a-flutter-data-entry-form-app-for-a-rental-agency-e5a7dab20596">https://medium.com/flutter-community/writing-a-flutter-data-entry-form-app-for-a-rental-agency-e5a7dab20596</a></p>
<p style="padding-left: 30px;"><a href="https://medium.com/flutter-community/using-svg-in-flutter-3dcf7b1dd713">https://medium.com/flutter-community/using-svg-in-flutter-3dcf7b1dd713</a></p>
<p style="padding-left: 30px;"><a href="https://medium.com/analytics-vidhya/deploy-ml-models-using-flask-as-rest-api-and-access-via-flutter-app-7ce63d5c1f3b">https://medium.com/analytics-vidhya/deploy-ml-models-using-flask-as-rest-api-and-access-via-flutter-app-7ce63d5c1f3b</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/wiltonribeiro/grocery_shop_flutter">https://github.com/wiltonribeiro/grocery_shop_flutter</a></p>
<p><iframe allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen" frameborder="0" height="315" src="https://www.youtube.com/embed/tBzJOb2Dopg" width="560"></iframe></p>
<p><iframe allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen" frameborder="0" height="315" src="https://www.youtube.com/embed/-QRQIKtPTlI" width="560"></iframe></p>
<h4>pubspec.yaml 中的支援版次表示法:</h4>
<p><a href="https://stackoverflow.com/questions/53563079/what-is-the-caret-sign-before-the-dependency-version-number-in-flutters-pub">https://stackoverflow.com/questions/53563079/what-is-the-caret-sign-before-the-dependency-version-number-in-flutters-pub</a></p>
<h4>參考資料:</h4>
<p style="padding-left: 30px;"><a href="https://github.com/flutter-devs/flutter_camera_demo">https://github.com/flutter-devs/flutter_camera_demo</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/nirav4273/flutter_hair_saloon">https://github.com/nirav4273/flutter_hair_saloon</a></p>
<p><br/>Quick Dart &lt;&lt; <a href="/get_page/Flutter/Quick Dart.html">Previous</a> <a href="/get_page/Flutter/Flutter Mobile.html">Next</a> &gt;&gt; Flutter Mobile</p>
<h2>discourse</h2>
<p><a href="https://github.com/discourse/discourse">https://github.com/discourse/discourse</a></p>
<p><a href="https://jpme.eng.nfu.edu.tw">https://jpme.eng.nfu.edu.tw</a></p>
<h3>操作管理</h3>
<h4>jpme.eng.nfu.edu.tw</h4>
<p>論壇程式碼: /var/www/discourse</p>
<p>設定檔案: /var/www/discourse/config/site_settings.yml</p>
<p>nginx 設定檔案位置: /etc/nginx/conf.d/discourse.conf</p>
<p>ssl_certificate 位於: /etc/letsencrypt/live/jpme.eng.nfu.edu.tw/fullchain.pem</p>
<p>ssl_certificate_key 位於: /etc/letscrypt/libe/jpme.eng.nfu.edu.tw/privkey.pem</p>
<p>重新啟動 sudo systemctl restart discourse</p>
<p>重新啟動 bind9: sudo service bind9 restart</p>
<p>Let's encrypt 改變 domain name:</p>
<p style="padding-left: 30px;">sudo certbot --nginx -d jpme.eng.nfu.edu.tw</p>
<p>為了讓 discourse 可以利用 Gmail SMTP replay 寄信, netplan 設定需要</p>
<p style="padding-left: 30px;">dhcp6: no</p>
<p style="padding-left: 30px;">accetp-ra: no</p>
<p>accept-ra (bool)<br/><br/>Accept Router Advertisement that would have the kernel configure IPv6 by itself.<br/>When enabled, accept Router Advertisements. When disabled, do not respond to<br/>Router Advertisements. If unset use the host kernel default setting.</p>
<p></p>
<h2>cd2020pj1</h2>
<p><a href="https://github.com/mdecourse/cd2020pj1">https://github.com/mdecourse/cd2020pj1</a></p>
<p style="padding-left: 30px;">Python 網際框架採用: <a href="https://flask.palletsprojects.com">https://flask.palletsprojects.com</a></p>
<p style="padding-left: 30px;">Oauth2 認證採用: <a href="https://github.com/authomatic/authomatic">https://github.com/authomatic/authomatic</a></p>
<p style="padding-left: 30px;">資料庫採用: sqlite3</p>
<p style="padding-left: 60px;">之後部署至 <a href="https://www.heroku.com/">Heroku</a> 預計使用 <a href="https://elements.heroku.com/addons/heroku-postgresql">https://elements.heroku.com/addons/heroku-postgresql</a></p>
<p>Flask upload:</p>
<p style="padding-left: 30px;"><a href="https://github.com/bboe/flask-image-uploader">https://github.com/bboe/flask-image-uploader</a></p>
<h3>Oauth2</h3>
<p>目前的 cd2020pj1 採用 authomatic:</p>
<p style="padding-left: 30px;"><a href="https://github.com/authomatic/authomatic">https://github.com/authomatic/authomatic</a></p>
<p><a href="https://pypi.org/project/python-oauth2/">https://pypi.org/project/python-oauth2/</a></p>
<h2>Network</h2>
<p><a href="https://www.wireshark.org/">https://www.wireshark.org/</a></p>
<p><a href="https://github.com/mgriffin/graphviz_network">https://github.com/mgriffin/graphviz_network</a></p>
<h2>Ref</h2>
<h3>LaTeX</h3>
<p><a href="https://github.com/latextemplates/scientific-thesis-template">https://github.com/latextemplates/scientific-thesis-template</a></p>
<h3>Automatic Control</h3>
<p><a href="/downloads/BookPythonForControl.pdf">BookPythonForControl.pdf</a></p>
<p><a href="http://python-control.sourceforge.net/manual/">http://python-control.sourceforge.net/manual/</a></p>
<p><a href="https://github.com/python-control/python-control">https://github.com/python-control/python-control</a></p>
<p><a href="https://pypi.org/project/control/">https://pypi.org/project/control/</a></p>
<p><a href="https://www.cds.caltech.edu/~murray/wiki/Control_Systems_Library_for_Python">https://www.cds.caltech.edu/~murray/wiki/Control_Systems_Library_for_Python</a></p>
<h3>參考步驟</h3>
<p>1. 閱讀</p>
<p style="padding-left: 30px;">2010 Feedback and Control for Everyone:</p>
<p style="padding-left: 60px;"><a href="https://link.springer.com/book/10.1007/978-3-642-03446-6">https://link.springer.com/book/10.1007/978-3-642-03446-6</a></p>
<p style="padding-left: 30px;">了解基本回授, 控制名詞與原理</p>
<p>2. 閱讀</p>
<p style="padding-left: 30px;">2012 Mechatronic Systems: </p>
<p style="padding-left: 60px;"><a href="https://link.springer.com/book/10.1007/978-3-642-22324-2">https://link.springer.com/book/10.1007/978-3-642-22324-2</a> </p>
<p style="padding-left: 30px;">了解機電系統與傳統與現代設計方法, 導入 Sympy 與 <a href="https://github.com/python-control/python-control">https://github.com/python-control/python-control,</a> <a href="/downloads/BookPythonForControl.pdf">2019 Python for Control.pdf</a> 與 <a href="/downloads/SymPy_Symbolic_computing_in_Python.pdf">Symbolic Computing in Python.pdf</a></p>
<p>3. 學習如何安裝配置 Ubuntu 20.04 實體與虛擬主機, 將 <a href="https://github.com/mdecourse/cmsimde">CMSiMDE</a> 靜態與動態網站分別配置在實體與虛擬伺服器上. 學習如何將動態 Flask 程式部署至 <a href="https://www.heroku.com/">Heroku.</a></p>
<p>4. 在 Ubuntu 20.04 伺服器上安裝 ubuntu-desktop 與 <a href="https://linuxize.com/post/how-to-install-xrdp-on-ubuntu-20-04/">Xrdp</a>, 安裝 <a href="https://www.coppeliarobotics.com/">CoppeliaSim</a>, 透過 Remote Desktop Client 連至遠端伺服器, 以 interactive 及 <a href="https://www.coppeliarobotics.com/helpFiles/en/commandLine.htm">headless</a> 開啟 <a href="https://www.coppeliarobotics.com/">CoppeliaSim</a> 場景檔案, 進行單機與網際 <a href="https://www.coppeliarobotics.com/helpFiles/en/remoteApiOverview.htm">Python Remote API</a> 模擬控制 <a href="https://www.coppeliarobotics.com/">CoppeliaSim</a> 場景中的機電系統.</p>
<p>5. 將 <a href="https://github.com/mdecourse/vrep_inverted_pendulum">https://github.com/mdecourse/vrep_inverted_pendulum</a> 改為 Python3 以及 CoppeliaSim 4.1.0 rev1 版本 (若要在 Acer E5200 電腦上執行, 必須使用 <a href="https://www.coppeliarobotics.com/previousVersions">V-rep 3.6.1 版</a>) 相容. 以下為參考資料:</p>
<p style="padding-left: 30px;"><a href="https://github.com/mdecourse/vrep-stuff">https://github.com/mdecourse/vrep-stuff</a></p>
<p style="padding-left: 30px;"><a href="http://ctms.engin.umich.edu/CTMS/index.php?example=InvertedPendulum&amp;section=SystemModeling">inverted pendulum system modeling</a></p>
<p style="padding-left: 30px;"><a href="/downloads/simulation of the inverted pendulum.pdf">simulation of the inverted pendulum.pdf</a></p>
<p style="padding-left: 30px;"><a href="https://ieeexplore.ieee.org/document/8833168">solve the inverted pendulum problem using DQN algorithm</a></p>
<p style="padding-left: 30px;"><a href="https://in.mathworks.com/help/control/ug/control-of-an-inverted-pendulum-on-a-cart.html">https://in.mathworks.com/help/control/ug/control-of-an-inverted-pendulum-on-a-cart.html</a></p>
<p style="padding-left: 30px;">其中的機電系統 3D 零組件可以採 <a href="https://docs.plm.automation.siemens.com/tdoc/nx/12/nx_help/#uid:index">NX12</a>, <a href="https://www.onshape.com/">Onshape</a> 或 <a href="http://solvespace.com/index.pl">Solvespace</a> 繪製.</p>
<h3>ebook1</h3>
<p>2010 Feedback and Control for Everyone:</p>
<p style="padding-left: 30px;"><a href="https://link.springer.com/book/10.1007/978-3-642-03446-6">https://link.springer.com/book/10.1007/978-3-642-03446-6</a></p>
<p>Control and Feedback are everywhere.</p>
<p>Feedback is information obtained from a system used to change its behavior.</p>
<p>A system is causal (符合因果關係) when for any signal in the behavior the future cannot influence the past of the signal. Because in our discussions signals are functions of time, causality (因果關係) is an all too natural a property. It is indeed not conceivable that the presently experienced shower temperature could possibly depend on future positions of the water taps. Indeed, our shower is a causal system (因果系統).</p>
<h3>Project</h3>
<p><a href="https://github.com/JuliaGraphics/Winston.jl">https://github.com/JuliaGraphics/Winston.jl</a> (2D plot)</p>
<p><a href="https://juliagraphics.github.io/Gtk.jl/latest/">https://juliagraphics.github.io/Gtk.jl/latest/</a> (GUI)</p>
<p><a href="https://github.com/JuliaGraphics/Cairo.jl">https://github.com/JuliaGraphics/Cairo.jl</a> (Graphics Library)</p>
<p>Pango - Layout engine library</p>
<p><a href="https://discourse.julialang.org/t/julia-for-gui-app/416/20">https://discourse.julialang.org/t/julia-for-gui-app/416/20</a> </p>
<p><a href="https://forum.gtkd.org/groups/GtkD/thread/57/">https://forum.gtkd.org/groups/GtkD/thread/57/</a> </p>
<hr/>
<p><a href="/downloads/julia_lang_in_machine_learning.pdf">Julia lang in machine learning.pdf</a></p>
<p><a href="https://diffeq.sciml.ai/dev/tutorials/ode_example/">https://diffeq.sciml.ai/dev/tutorials/ode_example/</a></p>
<p><a href="/downloads/2019_Julia for robotics simulation and real-time control in a high-level programming language.pdf">2019_Julia for robotics simulation and real-time control in a high-level programming language.pdf</a></p>
<p><a href="https://github.com/jdlangs/RobotOS.jl">https://github.com/jdlangs/RobotOS.jl</a></p>
<p><a href="https://github.com/JuliaRobotics">https://github.com/JuliaRobotics</a> </p>
<p><a href="https://juliarobotics.org/">https://juliarobotics.org/</a></p>
<p><a href="https://juliahub.com/ui/Packages/PyCall/GkzkC/1.92.1">https://juliahub.com/ui/Packages/PyCall/GkzkC/1.92.1</a></p>
<p><a href="https://www.robinly.info/post/keno-fisher-co-founder-julia-computing-developing-the-programming-language-of-the-future">https://www.robinly.info/post/keno-fisher-co-founder-julia-computing-developing-the-programming-language-of-the-future</a></p>
<p><a href="/downloads/First Semester in Numerical Analysis with Julia.pdf">First Semester Numerical Analysis course with Julia.pdf</a></p>
<p><a href="/downloads/Julia - A fresh approach to numerical computing.pdf">Julia - A fresh approach to numerical computing.pdf</a></p>
<p><a href="http://homepages.math.uic.edu/~jan/mcs471/index.html">http://homepages.math.uic.edu/~jan/mcs471/index.html</a> </p>
<p><a href="https://github.com/mitmath/18330">https://github.com/mitmath/18330</a> </p>
<p><a href="https://github.com/Djruhnke/numerical-analysis-julia">https://github.com/Djruhnke/numerical-analysis-julia</a> </p>
<h4>Julia language documentation:</h4>
<p style="padding-left: 30px;"><a href="https://docs.julialang.org/en/v1/">https://docs.julialang.org/en/v1/</a></p>
<p><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen" frameborder="0" height="315" src="https://www.youtube.com/embed/Bk4PJnjuPps" width="560"></iframe></p>
<p><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen" frameborder="0" height="315" src="https://www.youtube.com/embed/nKRIAbxNSQ8" width="560"></iframe></p>
<p><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen" frameborder="0" height="315" src="https://www.youtube.com/embed/dmWQtI3DFFo" width="560"></iframe></p>
<p><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen" frameborder="0" height="315" src="https://www.youtube.com/embed/zJ3R6vOhibA" width="560"></iframe></p>
<p><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen" frameborder="0" height="315" src="https://www.youtube.com/embed/gPYc77M90Qg" width="560"></iframe></p>
<h3>Ref2</h3>
<p><a href="https://github.com/brettkromkamp/topic-db">https://github.com/brettkromkamp/topic-db</a></p>
<p style="padding-left: 30px;"><a href="https://en.wikipedia.org/wiki/Topic_map">https://en.wikipedia.org/wiki/Topic_map</a></p>
<p style="padding-left: 30px;"><a href="https://www.isotopicmaps.org/sam/">https://www.isotopicmaps.org/sam/</a></p>
<p><a href="/downloads/The FAIR GuidingPrinciples for scientific datamanagement and stewardship.pdf">The FAIR GuidingPrinciples for scientific datamanagement and stewardship.pdf</a></p>
<p><a href="/downloads/A_Collective_Knowledge_workflow_for_collaborative_.pdf">A_Collective_Knowledge_workflow_for_collaborative_.pdf</a></p>
<p><a href="https://github.com/ctuning/ck">https://github.com/ctuning/ck</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/ctuning/ai">https://github.com/ctuning/ai</a></p>
<p style="padding-left: 30px;"><a href="https://github.com/ctuning/ck-tensorflow">https://github.com/ctuning/ck-tensorflow</a></p>
<p><a href="/downloads/2020_Collective Knowledge.pdf">2020_Collective Knowledge.pdf</a></p>
<p><a href="https://www.reddit.com/r/MachineLearning/comments/ioq8do/n_reproducing_150_research_papers_the_problems/?utm_source=share&amp;utm_medium=web2x&amp;context=3">Reproducing 150 research papers: the problems and solutions</a></p>
<p><a href="https://github.com/thegrumpys/odop">https://github.com/thegrumpys/odop</a></p>
<p style="padding-left: 30px;"><a href="https://www.topicmaps.org/">https://www.topicmaps.org/</a></p>
<p style="padding-left: 30px;"><a href="https://www.topicmaps.org/datamodel/">https://www.topicmaps.org/datamodel/</a></p>
<p style="padding-left: 30px;"><a href="/downloads/A_data-driven_approach_for_understanding_Open_Desi.pdf">A_data-driven_approach_for_understanding_Open_Desi.pdf</a></p>
<p><a href="https://fastpath2020.github.io/Program">https://fastpath2020.github.io/Program</a></p>
<p><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen" frameborder="0" height="315" src="https://www.youtube.com/embed/HTu7RokJsxc" width="560"></iframe></p>
<p><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="allowfullscreen" frameborder="0" height="315" src="https://www.youtube.com/embed/8Qa0E1jdkrE" width="560"></iframe></p>
<h3>Bond Graphs</h3>
<p><a href="https://github.com/mdecourse/BondGraphTools">https://github.com/mdecourse/BondGraphTools</a> </p>
<p><a href="https://www.gawthrop.net/Books/GawSmi96.pdf">https://www.gawthrop.net/Books/GawSmi96.pdf</a> </p>
<p><a href="/downloads/bond_graph_modeling.pdf">Bond Graph Modeling.pdf</a></p>
<p><a href="/downloads/Bond Graph Modeling and Simulation of Mechatronic.pdf">Bond Graph Modeling and Simulation of Mechatronic.pdf</a></p>
<p><a href="/downloads/bond_graph_modeling_postprint.pdf">bond_graph_modeling_postprint.pdf</a></p>
<p><a href="https://openmodelica.org/doc/OpenModelicaUsersGuide/latest/ompython.html">https://openmodelica.org/doc/OpenModelicaUsersGuide/latest/ompython.html</a> </p>
<h3>KMOLBrowser</h3>
<p>利用 <a href="https://www.qt.io/qt-for-python">pyside2</a> 編寫的網際瀏覽器:</p>
<p>KMOLBrowser 原始碼來自 <a href="https://github.com/ralsina/devicenzo">https://github.com/ralsina/devicenzo</a>, 為了用於 KMOLab 中 cmsimde self-signed certificate 近端或遠端編輯, 特別使用 ignoreCertificateError(), 讓網頁可以直接導入. 執行時可攜系統需要 pip install pyside2</p>
<pre class="brush:py;auto-links:false;toolbar:false" contenteditable="false">#!/usr/bin/env python3
"""
source from: https://github.com/ralsina/devicenzo
"""

import json
import os
import sys

from PySide2 import QtCore, QtGui, QtNetwork, QtWebEngineWidgets, QtWidgets

settings = QtCore.QSettings("ralsina", "devicenzo")


def set_ssl_protocol():
    default_config = QtNetwork.QSslConfiguration.defaultConfiguration()
    default_config.setProtocol(QtNetwork.QSsl.TlsV1_2)
    QtNetwork.QSslConfiguration.setDefaultConfiguration(default_config)


class WebEnginePage(QtWebEngineWidgets.QWebEnginePage):
    def certificateError(self, certificateError):
        """according to https://doc.qt.io/qtforpython/PySide2/QtWebEngineWidgets/QWebEngineCertificateError.html#PySide2.QtWebEngineWidgets.PySide2.QtWebEngineWidgets.QWebEngineCertificateError.ignoreCertificateError
        #PySide2.QtWebEngineWidgets.QWebEngineCertificateError.ignoreCertificateError()
        # here we allow self-signed certificate to load the web site directly
        """
        certificateError.ignoreCertificateError()
        return super(WebEnginePage, self).certificateError(certificateError)
        
        # the following is for printing error message and types
        print(certificateError.errorDescription(), certificateError.url(), certificateError.isOverridable())
        error = certificateError.error()
        if error == QtWebEngineWidgets.QWebEngineCertificateError.SslPinnedKeyNotInCertificateChain:
            print("SslPinnedKeyNotInCertificateChain")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateCommonNameInvalid:
            print("CertificateCommonNameInvalid")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateDateInvalid:
            print("CertificateDateInvalid")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateAuthorityInvalid:
            print("CertificateAuthorityInvalid")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateContainsErrors:
            print("CertificateContainsErrors")
        if error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateNoRevocationMechanism:
            print("CertificateNoRevocationMechanism")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateUnableToCheckRevocation:
            print("CertificateUnableToCheckRevocation")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateRevoked:
            print("CertificateRevoked")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateInvalid:
            print("CertificateAuthorityInvalid")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateWeakSignatureAlgorithm:
            print("CertificateWeakSignatureAlgorithm")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateNonUniqueName:
            print("CertificateNonUniqueName")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateWeakKey:
            print("CertificateWeakKey")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateNameConstraintViolation:
            print("CertificateNameConstraintViolation")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateValidityTooLong:
            print("CertificateValidityTooLong")
        elif error == QtWebEngineWidgets.QWebEngineCertificateError.CertificateTransparencyRequired:
            print("CertificateTransparencyRequired")

        return super(WebEnginePage, self).certificateError(certificateError)
        

class MainWindow(QtWidgets.QMainWindow):
    def __init__(self):
        super(MainWindow, self).__init__()
        self.tabs = QtWidgets.QTabWidget(
            self, tabsClosable=True, movable=True, elideMode=QtCore.Qt.ElideRight
        )
        self.tabs.tabCloseRequested.connect(
            lambda idx: self.tabs.widget(idx).deleteLater()
        )
        self.tabs.currentChanged.connect(self.currentTabChanged)
        self.close_current_tab = QtWidgets.QAction(shortcut=QtGui.QKeySequence.Close)
        self.close_current_tab.triggered.connect(
            lambda: self.tabs.currentWidget().deleteLater()
        )
        self.addAction(self.close_current_tab)
        self.setCentralWidget(self.tabs)
        self.bars = {}
        self.star_action = QtWidgets.QAction(
            QtGui.QIcon.fromTheme("user-bookmarks"),
            "Bookmark",
            self,
            checkable=True,
            triggered=self.bookmarkPage,
            shortcut="Ctrl+d",
        )
        self.tabs.setCornerWidget(
            QtWidgets.QToolButton(
                self,
                text="New Tab",
                icon=QtGui.QIcon.fromTheme("document-new"),
                clicked=lambda: self.addTab().url.setFocus(),
                shortcut=QtGui.QKeySequence.AddTab,
            )
        )
        self.full_screen_action = QtWidgets.QAction(
            "Full Screen", self, checkable=True, shortcut=QtGui.QKeySequence.FullScreen
        )
        self.full_screen_action.toggled.connect(
            lambda v: self.showFullScreen() if v else self.showNormal()
        )
        self.addAction(self.full_screen_action)
        self.bookmarks = self.get("bookmarks", {})
        # Bookmarks seem broken
        self.bookmarkPage()  # Load the bookmarks menu
        self.history = self.get("history", []) + list(self.bookmarks.keys())
        self.completer = QtWidgets.QCompleter(self.history)

        # Downloads bar at the bottom of the window
        self.downloads = QtWidgets.QToolBar("Downloads")
        self.addToolBar(QtCore.Qt.BottomToolBarArea, self.downloads)

        # Proxy support
        proxy_url = QtCore.QUrl(os.environ.get("http_proxy", ""))
        QtNetwork.QNetworkProxy.setApplicationProxy(
            QtNetwork.QNetworkProxy(
                QtNetwork.QNetworkProxy.HttpProxy
                if proxy_url.scheme().startswith("http")
                else QtNetwork.QNetworkProxy.Socks5Proxy,
                proxy_url.host(),
                proxy_url.port(),
                proxy_url.userName(),
                proxy_url.password(),
            )
        ) if "http_proxy" in os.environ else None

        [self.addTab(QtCore.QUrl(u)) for u in self.get("tabs", [])]

    def finished(self):
        url = self.sender().url().toString()
        bar, reply, fname, cancel = self.bars[url]
        redirURL = reply.attribute(
            QtNetwork.QNetworkRequest.RedirectionTargetAttribute
        ).toString()
        del self.bars[url]
        bar.deleteLater()
        cancel.deleteLater()
        if redirURL and redirURL != url:
            return self.fetch(redirURL, fname)

        with open(fname, "wb") as f:
            f.write(str(reply.readAll()))

    def progress(self, received, total):
        self.bars[self.sender().url().toString()][0].setValue(100.0 * received / total)

    def closeEvent(self, ev):
        self.put("history", self.history)
        self.put(
            "tabs", [self.tabs.widget(i).url.text() for i in range(self.tabs.count())]
        )
        return QtWidgets.QMainWindow.closeEvent(self, ev)

    def put(self, key, value):
        "Persist an object somewhere under a given key"
        settings.setValue(key, json.dumps(value))
        settings.sync()

    def get(self, key, default=None):
        "Get the object stored under 'key' in persistent storage, or the default value"
        v = settings.value(key)
        return json.loads(v) if v else default

    def addTab(self, url=QtCore.QUrl("")):
        self.tabs.setCurrentIndex(self.tabs.addTab(Tab(url, self), ""))
        return self.tabs.currentWidget()

    def currentTabChanged(self, idx):
        if self.tabs.widget(idx) is None:
            return self.close()

        self.setWindowTitle(self.tabs.widget(idx).web_view.title() or "De Vicenzo")

    def bookmarkPage(self, v=None):
        if v and v is not None:
            self.bookmarks[
                self.tabs.currentWidget().url.text()
            ] = self.tabs.currentWidget().web_view.title()
        elif v is not None:
            del (self.bookmarks[self.tabs.currentWidget().url.text()])
        self.star_action.setMenu(QtWidgets.QMenu())
        [
            self.star_action.menu().addAction(
                QtWidgets.QAction(
                    title,
                    self,
                    triggered=lambda u=QtCore.QUrl(url): self.tabs.currentWidget().load(
                        u
                    ),
                )
            )
            for url, title in self.bookmarks.items()
        ]
        self.put("bookmarks", self.bookmarks)

    def addToHistory(self, url):
        self.history.append(url)
        self.completer.setModel(
            QtCore.QStringListModel(
                list(set(list(self.bookmarks.keys()) + self.history))
            )
        )


class Tab(QtWidgets.QWidget):
    def __init__(self, url, container):
        super(Tab, self).__init__()
        self.container = container
        self.web_view = QtWebEngineWidgets.QWebEngineView()
        self.progress_bar = QtWidgets.QProgressBar(
            self.container.statusBar(), maximumWidth=120, visible=False
        )
        self.web_view.loadProgress.connect(
            lambda v: (self.progress_bar.show(), self.progress_bar.setValue(v))
            if self.amCurrent()
            else None
        )
        self.web_view.loadFinished.connect(self.progress_bar.hide)
        self.web_view.loadStarted.connect(
            lambda: self.progress_bar.show() if self.amCurrent() else None
        )
        self.web_view.titleChanged.connect(
            lambda t: container.tabs.setTabText(container.tabs.indexOf(self), t)
            or (container.setWindowTitle(t) if self.amCurrent() else None)
        )
        self.web_view.iconChanged.connect(
            lambda: container.tabs.setTabIcon(
                container.tabs.indexOf(self), self.web_view.icon()
            )
        )
        self.tb = QtWidgets.QToolBar("Main Toolbar", self)

        layout = QtWidgets.QVBoxLayout()
        layout.setContentsMargins(0, 0, 0, 0)
        layout.addWidget(self.tb, stretch=0)
        layout.addWidget(self.web_view, stretch=1000)
        layout.activate()
        self.setLayout(layout)
        for a, sc in [
            [QtWebEngineWidgets.QWebEnginePage.Back, QtGui.QKeySequence.Back],
            [QtWebEngineWidgets.QWebEnginePage.Forward, QtGui.QKeySequence.Forward],
            [QtWebEngineWidgets.QWebEnginePage.Reload, QtGui.QKeySequence.Refresh],
        ]:
            self.tb.addAction(self.web_view.pageAction(a))
            self.web_view.pageAction(a).setShortcut(sc)

        def save_page(*a, view=self.web_view):
            destination = QtWidgets.QFileDialog.getSaveFileName(self, "Save Page")
            print(repr(destination))
            if destination:
                view.page().save(destination[0])

        self.web_view.pageAction(
            QtWebEngineWidgets.QWebEnginePage.SavePage
        ).triggered.connect(save_page)

        self.url = QtWidgets.QLineEdit()
        self.url.returnPressed.connect(
            lambda: self.web_view.load(QtCore.QUrl.fromUserInput(self.url.text()))
        )
        self.url.setCompleter(container.completer)
        self.tb.addWidget(self.url)
        self.tb.addAction(container.star_action)

        self.web_view.urlChanged.connect(lambda u: self.url.setText(u.toString()))
        self.web_view.urlChanged.connect(lambda u: container.addToHistory(u.toString()))
        self.web_view.urlChanged.connect(
            lambda u: container.star_action.setChecked(
                u.toString() in container.bookmarks
            )
            if self.amCurrent()
            else None
        )

        self.web_view.page().linkHovered.connect(
            lambda l: container.statusBar().showMessage(l, 3000)
        )

        self.search = QtWidgets.QLineEdit(
            self.web_view, visible=False, maximumWidth=200
        )
        self.search.returnPressed.connect(
            lambda: self.web_view.findText(self.search.text())
        )
        self.search.textChanged.connect(
            lambda: self.web_view.findText(self.search.text())
        )
        self.showSearch = QtWidgets.QShortcut(QtGui.QKeySequence.Find, self)
        self.showSearch.activated.connect(
            lambda: self.search.show() or self.search.setFocus()
        )
        self.hideSearch = QtWidgets.QShortcut(
            "Esc", self, activated=lambda: (self.search.hide(), self.setFocus())
        )

        self.zoomIn = QtWidgets.QShortcut(QtGui.QKeySequence.ZoomIn, self)
        self.zoomIn.activated.connect(
            lambda: self.web_view.setZoomFactor(self.web_view.zoomFactor() + 0.2)
        )
        self.zoomOut = QtWidgets.QShortcut(QtGui.QKeySequence.ZoomOut, self)
        self.zoomOut.activated.connect(
            lambda: self.web_view.setZoomFactor(self.web_view.zoomFactor() - 0.2)
        )
        self.zoomOne = QtWidgets.QShortcut(
            "Ctrl+0", self, activated=lambda: self.web_view.setZoomFactor(1)
        )
        self.urlFocus = QtWidgets.QShortcut("Ctrl+l", self, activated=self.url.setFocus)

        page = WebEnginePage(self)
        self.web_view.setPage(page)
        page.load(QtCore.QUrl(url))
        


    def amCurrent(self):
        return self.container.tabs.currentWidget() == self

    def createWindow(self, windowType):
        return self.container.addTab()


if __name__ == "__main__":
    app = QtWidgets.QApplication(sys.argv)
    wb = MainWindow()
    for url in sys.argv[1:]:
        wb.addTab(QtCore.QUrl.fromUserInput(url))
    if wb.tabs.count() == 0:
        wb.addTab(QtCore.QUrl("http://mde.tw"))
    wb.show()
    sys.exit(app.exec_())
</pre>
<p></p>
<h3>Glowscript</h3>
<p><a href="https://www.glowscript.org/">https://www.glowscript.org/</a> </p>
<p><a href="https://github.com/vpython/glowscript">https://github.com/vpython/glowscript</a> </p>
<p><a href="https://github.com/atsepkov/RapydScript">https://github.com/atsepkov/RapydScript</a> </p>
<p><a href="https://bphilhour.trinket.io/physics-through-glowscript-an-introductory-course#/1-introduction-objects-parameters-and-the-3d-environment/welcome-and-introduction">Examples</a></p>
<div class="glowscript" id="glowscript">
<script src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery-ui.custom.min.js" type="text/javascript"></script>
<script src="https://s3.amazonaws.com/glowscript/package/glow.3.0.min.js" type="text/javascript"></script>
<script type="text/javascript">
window.__context = { glowscript_container: $("#glowscript").removeAttr("id") }
async function __main__() { // async wrapper permits use of await outside your own functions

var vector = vec // optional: makes vector a synonym of the fundamental vec
let scene = canvas()
let b = box({color:color.cyan})
async function f(obj) { // needs async because f() contains an await
    let t = clock()
    while (true) {
        await rate(100)
        obj.rotate({angle:0.01, axis:vec(0,1,0)})
         // rotate forever
        //if (clock()-t > 3) break
    }
    return 25
}
let x = await f(b) // needs await (inside async __main__) because f() contains an await
//print(x)
} // end of __main__ wrapper
__main__()
</script>
</div>
<h3>Rapydscript</h3>
<h4>Test embedded RapydScript</h4>
<script src="https://sw.kovidgoyal.net/rapydscript/repl/rapydscript.js"></script>
<script>
var compiler = RapydScript.create_embedded_compiler();
var js = compiler.compile(`
def hello_world():
    sum=0
    for i in range(11):
        sum=sum+i
    print(sum)
    alert("from 1 add to 10 is :" + str(sum))`);
function mySum() {
    document.body.textContent = js;
    eval(js);
    eval('hello_world()');
};
</script>
<p><button onclick="mySum()">Add from 1 to 10</button></p>
<p>Source Codes:</p>
<pre class="brush:html;auto-links:false;toolbar:false" contenteditable="false">&lt;h4&gt;Test embedded RapydScript&lt;/h4&gt;
&lt;script src="https://sw.kovidgoyal.net/rapydscript/repl/rapydscript.js"&gt;&lt;/script&gt;
&lt;script&gt;// &lt;![CDATA[
var compiler = RapydScript.create_embedded_compiler();
var js = compiler.compile(`
def hello_world():
    sum=0
    for i in range(11):
        sum=sum+i
    print(sum)
    alert("from 1 add to 10 is :" + str(sum))`);
function mySum() {
    document.body.textContent = js;
    eval(js);
    eval('hello_world()');
};
// ]]&gt;&lt;/script&gt;
&lt;p&gt;&lt;button onclick="mySum()"&gt;Add from 1 to 10&lt;/button&gt;&lt;/p&gt;</pre>
<p></p>
<h3>Atoms</h3>
<div class="glowscript" id="glowscript">
<script src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery.min.js" type="text/javascript"></script>
<script src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery-ui.custom.min.js" type="text/javascript"></script>
<script src="https://s3.amazonaws.com/glowscript/package/glow.3.0.min.js" type="text/javascript"></script>
<script type="text/javascript">
//--><![CDATA[//><!--

// START JAVASCRIPT
;(function() {;
async function __main__() {
"use strict";

var version = ["3.0", "glowscript"];
Array.prototype.toString = function() { return __parsearray(this) };
var scene = canvas();
var vector = vec;
var axes = [vec(1,0,0), vec(0,1,0), vec(0,0,1)]

var k = 1
var m = 1
var spacing = 1.0
var atom_radius = 0.3["*"](spacing)
var L0 = spacing["-"](1.8["*"](atom_radius))
var V0 = pi["*"](pow(0.5["*"](atom_radius),2))["*"](L0) // initial volume of spring
var N = 3
var crystal = makeCrystal(N, atom_radius, spacing, 0.1["*"](spacing)["*"](sqrt(k["/"](m))))
scene.center = 0.5["*"](N["-"](1))["*"](vec(1,1,1))
scene.autoscale = false
var dt = 0.04["*"](2["*"](pi)["*"](sqrt(m["/"](k))))

// Display text below the 3D graphics:
scene.title = "A model of a solid represented as atoms connected by interatomic bonds"

function makeCrystal( N, atom_radius, spacing, momentumRange ) {
    var crystal = { atoms:[], springs:[] }
    var atom
    var x,y,z

    function atomAt(np) {
        if (np.x[">="](0) && np.y[">="](0) && np.z[">="](0) && np.x["<"](N) && np.y["<"](N) && np.z["<"](N))
            return crystal.atoms[np.x["+"](np.y["*"](N))["+"](np.z["*"](N)["*"](N))]
        // Otherwise create an invisible wall and return it
        var w = box()
        w.visible = false  // comment out to see the true model
        w.size = atom_radius["*"](vec(1,1,1))
        w.pos = np["*"](spacing)
        w.momentum = vec(0,0,0)
        return w
    }

    // Create N^3 atoms in a grid
    for(z=0; z["<"](N); z++)
        for(y=0; y["<"](N); y++)
            for(x=0; x["<"](N); x++) {
                atom = sphere()
                atom.pos = vec(x,y,z)["*"](spacing)
                atom.size = 2["*"](atom_radius)["*"](vec(1,1,1))
                atom.color = vec(0,0.58,0.69)
                atom.momentum = momentumRange["*"](vec.random())
                crystal.atoms.push( atom )
            }
    
    // Create a grid of springs linking each atom to the adjacent atoms
    // in each dimension, or to invisible walls where no atom is adjacent
    for(var d=0; d["<"](3); d++)
        for(z=1["-u"](); z["<"](N); z++)
            for(y=1["-u"](); y["<"](N); y++)
                for(x=1["-u"](); x["<"](N); x++) {
                    atom = atomAt(vec(x,y,z))
                    var neighbor = atomAt(vec(x,y,z)["+"](axes[d]))

                    if (atom.visible || neighbor.visible) {
                        var spring = helix()
                        spring.visible = atom.visible && neighbor.visible
                        spring.thickness = 0.05
                        spring.size = vec(spacing,atom_radius,atom_radius)
                        spring.atoms = [ atom, neighbor ]
                        spring.color = vec(1,0.5,0)
                        crystal.springs.push(spring)
                    }
                }
    return crystal
}

while (true) {
    await rate(60)
    for(var a=0; a["<"](crystal.atoms.length); a++) {
        var atom = crystal.atoms[a]
        atom.pos = atom.pos["+"](atom.momentum["/"](m)["*"](dt))
    }
    for(var s=0; s["<"](crystal.springs.length); s++) {
        var spring = crystal.springs[s]
        spring.axis = spring.atoms[1].pos["-"](spring.atoms[0].pos)
        var L = mag(spring.axis)
        spring.axis = spring.axis.norm()
        spring.pos = spring.atoms[0].pos["+"](0.5["*"](atom_radius)["*"](spring.axis))
        var Ls = L["-"](1["*"](atom_radius))
        spring.size.x = Ls
        var Fdt = spring.axis["*"](k["*"](dt)["*"](1["-"](spacing["/"](L))))
        spring.atoms[0].momentum = spring.atoms[0].momentum["+"](Fdt)
        spring.atoms[1].momentum = spring.atoms[1].momentum["-"](Fdt)
    }
}

}
;$(function(){ window.__context = { glowscript_container: $("#glowscript").removeAttr("id") }; __main__() })})()
// END JAVASCRIPT

//--><!
</script>
</div>
<p>Source Codes:</p>
<pre class="brush:html;auto-links:false;toolbar:false" contenteditable="false">&lt;div class="glowscript" id="glowscript"&gt;
&lt;script type="text/javascript" src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery-ui.custom.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="https://s3.amazonaws.com/glowscript/package/glow.3.0.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;// &lt;![CDATA[
//--&gt;&lt;![CDATA[//&gt;&lt;!--

// START JAVASCRIPT
;(function() {;
async function __main__() {
"use strict";

var version = ["3.0", "glowscript"];
Array.prototype.toString = function() { return __parsearray(this) };
var scene = canvas();
var vector = vec;
var axes = [vec(1,0,0), vec(0,1,0), vec(0,0,1)]

var k = 1
var m = 1
var spacing = 1.0
var atom_radius = 0.3["*"](spacing)
var L0 = spacing["-"](1.8["*"](atom_radius))
var V0 = pi["*"](pow(0.5["*"](atom_radius),2))["*"](L0) // initial volume of spring
var N = 3
var crystal = makeCrystal(N, atom_radius, spacing, 0.1["*"](spacing)["*"](sqrt(k["/"](m))))
scene.center = 0.5["*"](N["-"](1))["*"](vec(1,1,1))
scene.autoscale = false
var dt = 0.04["*"](2["*"](pi)["*"](sqrt(m["/"](k))))

// Display text below the 3D graphics:
scene.title = "A model of a solid represented as atoms connected by interatomic bonds"

function makeCrystal( N, atom_radius, spacing, momentumRange ) {
    var crystal = { atoms:[], springs:[] }
    var atom
    var x,y,z

    function atomAt(np) {
        if (np.x["&gt;="](0) &amp;&amp; np.y["&gt;="](0) &amp;&amp; np.z["&gt;="](0) &amp;&amp; np.x["&lt;"](N) &amp;&amp; np.y["&lt;"](N) &amp;&amp; np.z["&lt;"](N))
            return crystal.atoms[np.x["+"](np.y["*"](N))["+"](np.z["*"](N)["*"](N))]
        // Otherwise create an invisible wall and return it
        var w = box()
        w.visible = false  // comment out to see the true model
        w.size = atom_radius["*"](vec(1,1,1))
        w.pos = np["*"](spacing)
        w.momentum = vec(0,0,0)
        return w
    }

    // Create N^3 atoms in a grid
    for(z=0; z["&lt;"](N); z++)
        for(y=0; y["&lt;"](N); y++)
            for(x=0; x["&lt;"](N); x++) {
                atom = sphere()
                atom.pos = vec(x,y,z)["*"](spacing)
                atom.size = 2["*"](atom_radius)["*"](vec(1,1,1))
                atom.color = vec(0,0.58,0.69)
                atom.momentum = momentumRange["*"](vec.random())
                crystal.atoms.push( atom )
            }
    
    // Create a grid of springs linking each atom to the adjacent atoms
    // in each dimension, or to invisible walls where no atom is adjacent
    for(var d=0; d["&lt;"](3); d++)
        for(z=1["-u"](); z["&lt;"](N); z++)
            for(y=1["-u"](); y["&lt;"](N); y++)
                for(x=1["-u"](); x["&lt;"](N); x++) {
                    atom = atomAt(vec(x,y,z))
                    var neighbor = atomAt(vec(x,y,z)["+"](axes[d]))

                    if (atom.visible || neighbor.visible) {
                        var spring = helix()
                        spring.visible = atom.visible &amp;&amp; neighbor.visible
                        spring.thickness = 0.05
                        spring.size = vec(spacing,atom_radius,atom_radius)
                        spring.atoms = [ atom, neighbor ]
                        spring.color = vec(1,0.5,0)
                        crystal.springs.push(spring)
                    }
                }
    return crystal
}

while (true) {
    await rate(60)
    for(var a=0; a["&lt;"](crystal.atoms.length); a++) {
        var atom = crystal.atoms[a]
        atom.pos = atom.pos["+"](atom.momentum["/"](m)["*"](dt))
    }
    for(var s=0; s["&lt;"](crystal.springs.length); s++) {
        var spring = crystal.springs[s]
        spring.axis = spring.atoms[1].pos["-"](spring.atoms[0].pos)
        var L = mag(spring.axis)
        spring.axis = spring.axis.norm()
        spring.pos = spring.atoms[0].pos["+"](0.5["*"](atom_radius)["*"](spring.axis))
        var Ls = L["-"](1["*"](atom_radius))
        spring.size.x = Ls
        var Fdt = spring.axis["*"](k["*"](dt)["*"](1["-"](spacing["/"](L))))
        spring.atoms[0].momentum = spring.atoms[0].momentum["+"](Fdt)
        spring.atoms[1].momentum = spring.atoms[1].momentum["-"](Fdt)
    }
}

}
;$(function(){ window.__context = { glowscript_container: $("#glowscript").removeAttr("id") }; __main__() })})()
// END JAVASCRIPT

//--&gt;&lt;!
// ]]&gt;&lt;/script&gt;
&lt;/div&gt;</pre>
<p></p>
<h3>Samples</h3>
<div class="glowscript" id="glowscript">
<script src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery.min.js" type="text/javascript"></script>
<script src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery-ui.custom.min.js" type="text/javascript"></script>
<script src="https://s3.amazonaws.com/glowscript/package/glow.3.0.min.js" type="text/javascript"></script>
<script type="text/javascript">
//--><![CDATA[//><!--

// START JAVASCRIPT
;(function() {;
async function __main__() {
"use strict";

var version = ["3.0", "glowscript"];
Array.prototype.toString = function() { return __parsearray(this) };
var scene = canvas();
var vector = vec;

scene.title = "A ball bounces in a box"
/*
var s = 'To rotate "camera", drag with right button or Ctrl-drag.<br>'
s=s["+"]("To zoom, drag with middle button or Alt/Option depressed, or use scroll wheel.<br>")
s=s["+"]("  On a two-button mouse, middle is left + right.<br>")
s=s["+"]("To pan left/right and up/down, Shift-drag.<br>")
s=s["+"]("Touch screen: pinch/extend to zoom, swipe or two-finger rotate.<br>")
scene.caption = s
*/
var side = 4.0
var thk = 0.3
var s2 = 2["*"](side)["-"](thk)
var s3 = 2["*"](side)["+"](thk)
var wallR = box ( {pos:vec( side, 0, 0), size:vec(thk,s2,s3),  color : color.red} )
var wallL = box ( {pos:vec(side["-u"](), 0, 0), size:vec(thk,s2,s3),  color : color.red} )
var wallB = box ( {pos:vec(0, side["-u"](), 0), size:vec(s3,thk,s3),  color : color.blue} )
var wallT = box ( {pos:vec(0,  side, 0), size:vec(s3,thk,s3),  color : color.blue} )
var wallBK = box( {pos:vec(0, 0, side["-u"]()), size:vec(s2,s2,thk), color : color.gray(0.7)} )

var ball = sphere ( {color : color.green, size : 0.8["*"](vec(1,1,1))} )
ball.mass = 1.0
ball.p = vec (0.15["-u"](), 0.23["-u"](), 0.27)
attach_trail(ball, {pps:200, retain:100, color:ball.color})

side = side["-"](thk["*"](0.5))["-"](ball.size.x["/"](2))
var dt = 0.3

while ( true) { 
  // The rate statement tells GlowScript to execute the while statements
  // about 200 times per second. The "wait" keyword is necessary to permit
  // periodic updates to the window.
  await rate(200)
  ball.pos = ball.pos["+"](ball.p["/"](ball.mass)["*"](dt))
  if (! (side["-u"]()["<"](ball.pos.x) && ball.pos.x["<"](side))) { 
    ball.p.x = ball.p.x["-u"]()
  }
  if (! (side["-u"]()["<"](ball.pos.y) && ball.pos.y["<"](side))) { 
    ball.p.y = ball.p.y["-u"]()
  }
  if (! (side["-u"]()["<"](ball.pos.z) && ball.pos.z["<"](side))) { 
    ball.p.z = ball.p.z["-u"]()
  }
}

}
;$(function(){ window.__context = { glowscript_container: $("#glowscript").removeAttr("id") }; __main__() })})()
// END JAVASCRIPT
//--><!
</script>
</div>
<p>Source Codes:</p>
<pre class="brush:html;auto-links:false;toolbar:false" contenteditable="false">&lt;div class="glowscript" id="glowscript"&gt;
&lt;script type="text/javascript" src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery-ui.custom.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="https://s3.amazonaws.com/glowscript/package/glow.3.0.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;

// START JAVASCRIPT
;(function() {;
async function __main__() {
"use strict";

var version = ["3.0", "glowscript"];
Array.prototype.toString = function() { return __parsearray(this) };
var scene = canvas();
var vector = vec;

scene.title = "A ball bounces in a box"

var side = 4.0
var thk = 0.3
var s2 = 2["*"](side)["-"](thk)
var s3 = 2["*"](side)["+"](thk)
var wallR = box ( {pos:vec( side, 0, 0), size:vec(thk,s2,s3),  color : color.red} )
var wallL = box ( {pos:vec(side["-u"](), 0, 0), size:vec(thk,s2,s3),  color : color.red} )
var wallB = box ( {pos:vec(0, side["-u"](), 0), size:vec(s3,thk,s3),  color : color.blue} )
var wallT = box ( {pos:vec(0,  side, 0), size:vec(s3,thk,s3),  color : color.blue} )
var wallBK = box( {pos:vec(0, 0, side["-u"]()), size:vec(s2,s2,thk), color : color.gray(0.7)} )

var ball = sphere ( {color : color.green, size : 0.8["*"](vec(1,1,1))} )
ball.mass = 1.0
ball.p = vec (0.15["-u"](), 0.23["-u"](), 0.27)
attach_trail(ball, {pps:200, retain:100, color:ball.color})

side = side["-"](thk["*"](0.5))["-"](ball.size.x["/"](2))
var dt = 0.3

while ( true) { 
  // The rate statement tells GlowScript to execute the while statements
  // about 200 times per second. The "wait" keyword is necessary to permit
  // periodic updates to the window.
  await rate(200)
  ball.pos = ball.pos["+"](ball.p["/"](ball.mass)["*"](dt))
  if (! (side["-u"]()["&lt;"](ball.pos.x) &amp;&amp; ball.pos.x["&lt;"](side))) { 
    ball.p.x = ball.p.x["-u"]()
  }
  if (! (side["-u"]()["&lt;"](ball.pos.y) &amp;&amp; ball.pos.y["&lt;"](side))) { 
    ball.p.y = ball.p.y["-u"]()
  }
  if (! (side["-u"]()["&lt;"](ball.pos.z) &amp;&amp; ball.pos.z["&lt;"](side))) { 
    ball.p.z = ball.p.z["-u"]()
  }
}

}
;$(function(){ window.__context = { glowscript_container: $("#glowscript").removeAttr("id") }; __main__() })})()
// END JAVASCRIPT
&lt;/script&gt;
&lt;/div&gt;</pre>
<p></p>
<h3>RLearning</h3>
<p>Train a model to balance a pole on a cart using reinforcement learning.</p>
<p>Description</p>
<p>This example illustrates how to use TensorFlow.js to perform simple <a href="https://en.wikipedia.org/wiki/Reinforcement_learning">reinforcement learning</a> (RL). Specifically, it showcases an implementation of the policy-gradient method in TensorFlow.js. This implementation is used to solve the classic <a href="https://en.wikipedia.org/wiki/Inverted_pendulum">cart-pole control problem.</a></p>
<p>Through <span>self play</span> the agent will learn to balance the pole for as many <span>steps</span> as it can.</p>
<p>Instructions</p>
<p></p>
<ul>
<li>Choose a hidden layer size and click "Create Model".</li>
<li>Select training parameters and then click "Train".</li>
<li>Note that while the model is training it periodically saves a copy of itself to local browser storage, this mean you can refresh the page and continue training from the last save point. If at any point you want to start training from scratch, click "Delete stored Model".</li>
<li>Once the model has finished training you can click "Test" to see how many 'steps' the agent can balance the pole for. You can also click 'Stop' to pause the training after the current iteration ends if you want to test the model sooner.</li>
<li>During training and testing a small simulation of the agent behaviour will be rendered.</li>
</ul>
<p>Status</p>
<div><span id="app-status">Standing by.</span></div>
<div>
<p>Initialize Model</p>
<div>
<div>
<div><label>Hidden layer size(s) (e.g.: "256", "32,64"):</label> <input id="hidden-layer-sizes" type="text" value="128"/></div>
<button disabled="disabled" id="create-model">Create model</button></div>
<div>
<div><label>Locally-stored model</label> <input disabled="disabled" id="stored-model-status" readonly="readonly" type="text" value="N/A"/></div>
<button disabled="disabled" id="delete-stored-model">Delete stored model</button></div>
</div>
<p>Training Parameters</p>
<div>
<div><label>Number of iterations:</label> <input id="num-iterations" type="text" value="20"/></div>
<div><label>Games per iteration:</label> <input id="games-per-iteration" type="text" value="20"/></div>
<div><label>Max. steps per game:</label> <input id="max-steps-per-game" type="text" value="500"/></div>
<div><label>Reward discount rate:</label> <input id="discount-rate" type="text" value="0.95"/></div>
<div><label>Learning rate:</label> <input id="learning-rate" type="text" value="0.05"/></div>
<div><label>Render during training:</label> <input id="render-during-training" type="checkbox"/> <span>Uncheck me to speed up training.</span></div>
<div><button disabled="disabled" id="train">Train</button> <button disabled="disabled" id="test">Test</button></div>
</div>
</div>
<p>Training Progress</p>
<div>
<div><label id="train-status">Iteration #:</label> <progress id="train-progress" max="100" value="0"></progress></div>
<div><label id="iteration-status">Game #:</label> <progress id="iteration-progress" max="100" value="0"></progress></div>
<div><label>Training speed:</label> <span id="train-speed"></span></div>
<div id="steps-container"></div>
</div>
<p>Simulation</p>
<div><canvas height="150px" id="cart-pole-canvas" width="500px"></canvas></div>
<script type="text/javascript">
//--><![CDATA[//><!--

tf.setBackend('cpu');
console.log(tf.getBackend());
var b,c

class CartPole {
  constructor() {
    // Constants that characterize the system.
    this.gravity = 9.8;
    this.massCart = 1.0;
    this.massPole = 0.1;
    this.totalMass = this.massCart + this.massPole;
    this.cartWidth = 0.2;
    this.cartHeight = 0.1;
    this.length = 0.5;
    this.poleMoment = this.massPole * this.length;
    this.forceMag = 10.0;
    this.tau = 0.02;  // Seconds between state updates.

    // Threshold values, beyond which a simulation will be marked as failed.
    this.xThreshold = 2.4;
    this.thetaThreshold = 12 / 360 * 2 * Math.PI;

    this.setRandomState();
  }

  setRandomState() {
    // The control-theory state variables of the cart-pole system.
    // Cart position, meters.
    this.x = Math.random() - 0.5;
    // Cart velocity.
    this.xDot = (Math.random() - 0.5) * 1;
    // Pole angle, radians.
    this.theta = (Math.random() - 0.5) * 2 * (6 / 360 * 2 * Math.PI);
    // Pole angle velocity.
    this.thetaDot =  (Math.random() - 0.5) * 0.5;
  }

  getStateTensor() {
    return tf.tensor2d([[this.x, this.xDot, this.theta, this.thetaDot]]);
  }

  update(action) {
    const force = action > 0 ? this.forceMag : -this.forceMag;

    const cosTheta = Math.cos(this.theta);
    const sinTheta = Math.sin(this.theta);

    const temp =
        (force + this.poleMoment * this.thetaDot * this.thetaDot * sinTheta) /
        this.totalMass;
    const thetaAcc = (this.gravity * sinTheta - cosTheta * temp) /
        (this.length *
         (4 / 3 - this.massPole * cosTheta * cosTheta / this.totalMass));
    const xAcc = temp - this.poleMoment * thetaAcc * cosTheta / this.totalMass;

    // Update the four state variables, using Euler's metohd.
    this.x += this.tau * this.xDot;
    this.xDot += this.tau * xAcc;
    this.theta += this.tau * this.thetaDot;
    this.thetaDot += this.tau * thetaAcc;

    return this.isDone();
  }


  isDone() {
    return this.x < -this.xThreshold || this.x > this.xThreshold ||
        this.theta < -this.thetaThreshold || this.theta > this.thetaThreshold;
  }
}


//--><!
</script>
<script type="text/javascript">
//--><![CDATA[//><!--

/**
 * Calculate the mean of an Array of numbers.
 *
 * @param {number[]} xs
 * @returns {number} The arithmetic mean of `xs`
 */
function mean(xs) {
  return sum(xs) / xs.length;
}

/**
 * Calculate the sum of an Array of numbers.
 *
 * @param {number[]} xs
 * @returns {number} The sum of `xs`.
 * @throws Error if `xs` is empty.
 */
function sum(xs) {
  if (xs.length === 0) {
    throw new Error('Expected xs to be a non-empty Array.');
  } else {
    return xs.reduce((x, prev) => prev + x);
  }
}
//--><!
</script>
<script type="text/javascript">
//--><![CDATA[//><!--

const appStatus = document.getElementById('app-status');
const storedModelStatusInput = document.getElementById('stored-model-status');
const hiddenLayerSizesInput = document.getElementById('hidden-layer-sizes');
const createModelButton = document.getElementById('create-model');
const deleteStoredModelButton = document.getElementById('delete-stored-model');
const cartPoleCanvas = document.getElementById('cart-pole-canvas');

const numIterationsInput = document.getElementById('num-iterations');
const gamesPerIterationInput = document.getElementById('games-per-iteration');
const discountRateInput = document.getElementById('discount-rate');
const maxStepsPerGameInput = document.getElementById('max-steps-per-game');
const learningRateInput = document.getElementById('learning-rate');
const renderDuringTrainingCheckbox =
    document.getElementById('render-during-training');

const trainButton = document.getElementById('train');
const testButton = document.getElementById('test');
const iterationStatus = document.getElementById('iteration-status');
const iterationProgress = document.getElementById('iteration-progress');
const trainStatus = document.getElementById('train-status');
const trainSpeed = document.getElementById('train-speed');
const trainProgress = document.getElementById('train-progress');

const stepsContainer = document.getElementById('steps-container');

// Module-global instance of policy network.
let policyNet;
let stopRequested = false;

/**
 * Display a message to the info div.
 *
 * @param {string} message The message to be displayed.
 */
function logStatus(message) {
  appStatus.textContent = message;
}

// Objects and functions to support display of cart pole status during training.
let renderDuringTraining = true;
async function maybeRenderDuringTraining(cartPole) {
  if (renderDuringTraining) {
    renderCartPole(cartPole, cartPoleCanvas);
    await tf.nextFrame();  // Unblock UI thread.
  }
}

/**
 * A function invoked at the end of every game during training.
 *
 * @param {number} gameCount A count of how many games has completed so far in
 *   the current iteration of training.
 * @param {number} totalGames Total number of games to complete in the current
 *   iteration of training.
 */
function onGameEnd(gameCount, totalGames) {
  iterationStatus.textContent = `Game ${gameCount} of ${totalGames}`;
  iterationProgress.value = gameCount / totalGames * 100;
  if (gameCount === totalGames) {
    iterationStatus.textContent = 'Updating weights...';
  }
}

/**
 * A function invokved at the end of a training iteration.
 *
 * @param {number} iterationCount A count of how many iterations has completed
 *   so far in the current round of training.
 * @param {*} totalIterations Total number of iterations to complete in the
 *   current round of training.
 */
function onIterationEnd(iterationCount, totalIterations) {
  trainStatus.textContent = `Iteration ${iterationCount} of ${totalIterations}`;
  trainProgress.value = iterationCount / totalIterations * 100;
}

// Objects and function to support the plotting of game steps during training.
let meanStepValues = [];
function plotSteps() {
  tfvis.render.linechart(stepsContainer, {values: meanStepValues}, {
    xLabel: 'Training Iteration',
    yLabel: 'Mean Steps Per Game',
    width: 400,
    height: 300,
  });
}

function disableModelControls() {
  trainButton.textContent = 'Stop';
  testButton.disabled = true;
  deleteStoredModelButton.disabled = true;
}

function enableModelControls() {
  trainButton.textContent = 'Train';
  testButton.disabled = false;
  deleteStoredModelButton.disabled = false;
}

/**
 * Render the current state of the system on an HTML canvas.
 *
 * @param {CartPole} cartPole The instance of cart-pole system to render.
 * @param {HTMLCanvasElement} canvas The instance of HTMLCanvasElement on which
 *   the rendering will happen.
 */
function renderCartPole(cartPole, canvas) {
  if (!canvas.style.display) {
    canvas.style.display = 'block';
  }
  const X_MIN = -cartPole.xThreshold;
  const X_MAX = cartPole.xThreshold;
  const xRange = X_MAX - X_MIN;
  const scale = canvas.width / xRange;

  const context = canvas.getContext('2d');
  context.clearRect(0, 0, canvas.width, canvas.height);
  const halfW = canvas.width / 2;

  // Draw the cart.
  const railY = canvas.height * 0.8;
  const cartW = cartPole.cartWidth * scale;
  const cartH = cartPole.cartHeight * scale;

  const cartX = cartPole.x * scale + halfW;

  context.beginPath();
  context.strokeStyle = '#000000';
  context.lineWidth = 2;
  context.rect(cartX - cartW / 2, railY - cartH / 2, cartW, cartH);
  context.stroke();

  // Draw the wheels under the cart.
  const wheelRadius = cartH / 4;
  for (const offsetX of [-1, 1]) {
    context.beginPath();
    context.lineWidth = 2;
    context.arc(
        cartX - cartW / 4 * offsetX, railY + cartH / 2 + wheelRadius,
        wheelRadius, 0, 2 * Math.PI);
    context.stroke();
  }

  // Draw the pole.
  const angle = cartPole.theta + Math.PI / 2;
  const poleTopX =
      halfW + scale * (cartPole.x + Math.cos(angle) * cartPole.length);
  const poleTopY = railY -
      scale * (cartPole.cartHeight / 2 + Math.sin(angle) * cartPole.length);
  context.beginPath();
  context.strokeStyle = '#ffa500';
  context.lineWidth = 6;
  context.moveTo(cartX, railY - cartH / 2);
  context.lineTo(poleTopX, poleTopY);
  context.stroke();

  // Draw the ground.
  const groundY = railY + cartH / 2 + wheelRadius * 2;
  context.beginPath();
  context.strokeStyle = '#000000';
  context.lineWidth = 1;
  context.moveTo(0, groundY);
  context.lineTo(canvas.width, groundY);
  context.stroke();

  const nDivisions = 40;
  for (let i = 0; i < nDivisions; ++i) {
    const x0 = canvas.width / nDivisions * i;
    const x1 = x0 + canvas.width / nDivisions / 2;
    const y0 = groundY + canvas.width / nDivisions / 2;
    const y1 = groundY;
    context.beginPath();
    context.moveTo(x0, y0);
    context.lineTo(x1, y1);
    context.stroke();
  }

  // Draw the left and right limits.
  const limitTopY = groundY - canvas.height / 2;
  context.beginPath();
  context.strokeStyle = '#ff0000';
  context.lineWidth = 2;
  context.moveTo(1, groundY);
  context.lineTo(1, limitTopY);
  context.stroke();
  context.beginPath();
  context.moveTo(canvas.width - 1, groundY);
  context.lineTo(canvas.width - 1, limitTopY);
  context.stroke();
}

async function updateUIControlState() {
  const modelInfo = await SaveablePolicyNetwork.checkStoredModelStatus();
  if (modelInfo == null) {
    storedModelStatusInput.value = 'No stored model.';
    deleteStoredModelButton.disabled = true;

  } else {
    storedModelStatusInput.value = `Saved@${modelInfo.dateSaved.toISOString()}`;
    deleteStoredModelButton.disabled = false;
    createModelButton.disabled = true;
  }
  createModelButton.disabled = policyNet != null;
  hiddenLayerSizesInput.disabled = policyNet != null;
  trainButton.disabled = policyNet == null;
  testButton.disabled = policyNet == null;
  renderDuringTrainingCheckbox.checked = renderDuringTraining;
}

async function setUpUI() {
  const cartPole = new CartPole(true);

  if (await SaveablePolicyNetwork.checkStoredModelStatus() != null) {
    policyNet = await SaveablePolicyNetwork.loadModel();
    logStatus('Loaded policy network from IndexedDB.');
    hiddenLayerSizesInput.value = policyNet.hiddenLayerSizes();
  }
  await updateUIControlState();

  renderDuringTrainingCheckbox.addEventListener('change', () => {
    renderDuringTraining = renderDuringTrainingCheckbox.checked;
  });

  createModelButton.addEventListener('click', async () => {
    try {
      const hiddenLayerSizes =
          hiddenLayerSizesInput.value.trim().split(',').map(v => {
            const num = Number.parseInt(v.trim());
            if (!(num > 0)) {
              throw new Error(
                  `Invalid hidden layer sizes string: ` +
                  `${hiddenLayerSizesInput.value}`);
            }
            return num;
          });
      policyNet = new SaveablePolicyNetwork(hiddenLayerSizes);
      console.log('DONE constructing new instance of SaveablePolicyNetwork');
      await updateUIControlState();
    } catch (err) {
      logStatus(`ERROR: ${err.message}`);
    }
  });

  deleteStoredModelButton.addEventListener('click', async () => {
    if (confirm(`Are you sure you want to delete the locally-stored model?`)) {
      await policyNet.removeModel();
      policyNet = null;
      await updateUIControlState();
    }
  });

  trainButton.addEventListener('click', async () => {
    if (trainButton.textContent === 'Stop') {
      stopRequested = true;
    } else {
      disableModelControls();

      try {
        const trainIterations = Number.parseInt(numIterationsInput.value);
        if (!(trainIterations > 0)) {
          throw new Error(`Invalid number of iterations: ${trainIterations}`);
        }
        const gamesPerIteration = Number.parseInt(gamesPerIterationInput.value);
        if (!(gamesPerIteration > 0)) {
          throw new Error(
              `Invalid # of games per iterations: ${gamesPerIteration}`);
        }
        const maxStepsPerGame = Number.parseInt(maxStepsPerGameInput.value);
        if (!(maxStepsPerGame > 1)) {
          throw new Error(`Invalid max. steps per game: ${maxStepsPerGame}`);
        }
        const discountRate = Number.parseFloat(discountRateInput.value);
        if (!(discountRate > 0 && discountRate < 1)) {
          throw new Error(`Invalid discount rate: ${discountRate}`);
        }
        const learningRate = Number.parseFloat(learningRateInput.value);

        logStatus(
            'Training policy network... Please wait. ' +
            'Network is saved to IndexedDB at the end of each iteration.');
        const optimizer = tf.train.adam(learningRate);

        meanStepValues = [];
        onIterationEnd(0, trainIterations);
        let t0 = new Date().getTime();
        stopRequested = false;
        for (let i = 0; i < trainIterations; ++i) {
          const gameSteps = await policyNet.train(
              cartPole, optimizer, discountRate, gamesPerIteration,
              maxStepsPerGame);
          const t1 = new Date().getTime();
          const stepsPerSecond = sum(gameSteps) / ((t1 - t0) / 1e3);
          t0 = t1;
          trainSpeed.textContent = `${stepsPerSecond.toFixed(1)} steps/s`
          meanStepValues.push({x: i + 1, y: mean(gameSteps)});
          console.log(`# of tensors: ${tf.memory().numTensors}`);
          plotSteps();
          onIterationEnd(i + 1, trainIterations);
          await tf.nextFrame();  // Unblock UI thread.
          await policyNet.saveModel();
          await updateUIControlState();

          if (stopRequested) {
            logStatus('Training stopped by user.');
            break;
          }
        }
        if (!stopRequested) {
          logStatus('Training completed.');
        }
      } catch (err) {
        logStatus(`ERROR: ${err.message}`);
      }
      enableModelControls();
    }
  });

  testButton.addEventListener('click', async () => {
    disableModelControls();
    let isDone = false;
    const cartPole = new CartPole(true);
    cartPole.setRandomState();
    let steps = 0;
    stopRequested = false;
    let a = 0;
    while (!isDone) {
      steps++;
      tf.tidy(() => {
        const action = policyNet.getActions(cartPole.getStateTensor())[0];
        logStatus(
            `Test in progress. ` +
            `Action: ${action === 1 ? '<--' : ' -->'} (Step ${steps})`);
        isDone = cartPole.update(action);
        if (typeof c !== "undefined"){
          c.pos.x = b.pos.x = cartPole.x
          c.rotate({angle:-a, axis:vec(0,0,1)})
          a = cartPole.theta
          c.rotate({angle:a, axis:vec(0,0,1)})
        }
        renderCartPole(cartPole, cartPoleCanvas);
      });
      await tf.nextFrame();  // Unblock UI thread.
      if (stopRequested) {
        break;
      }
    }
    if (stopRequested) {
      logStatus(`Test stopped by user after ${steps} step(s).`);
    } else {
      logStatus(`Test finished. Survived ${steps} step(s).`);
    }
    console.log(`# of tensors: ${tf.memory().numTensors}`);
    enableModelControls();
  });
}
//--><!
</script>
<script type="text/javascript">
//--><![CDATA[//><!--

/**
 * Policy network for controlling the cart-pole system.
 *
 * The role of the policy network is to select an action based on the observed
 * state of the system. In this case, the action is the leftward or rightward
 * force and the observed system state is a four-dimensional vector, consisting
 * of cart position, cart velocity, pole angle and pole angular velocity.
 *
 */
class PolicyNetwork {
  /**
   * Constructor of PolicyNetwork.
   *
   * @param {number | number[] | tf.LayersModel} hiddenLayerSizes
   *   Can be any of the following
   *   - Size of the hidden layer, as a single number (for a single hidden
   *     layer)
   *   - An Array of numbers (for any number of hidden layers).
   *   - An instance of tf.LayersModel.
   */
  constructor(hiddenLayerSizesOrModel) {
    if (hiddenLayerSizesOrModel instanceof tf.LayersModel) {
      this.policyNet = hiddenLayerSizesOrModel;
    } else {
      this.createPolicyNetwork(hiddenLayerSizesOrModel);
    }
  }

  /**
   * Create the underlying model of this policy network.
   *
   * @param {number | number[]} hiddenLayerSizes Size of the hidden layer, as
   *   a single number (for a single hidden layer) or an Array of numbers (for
   *   any number of hidden layers).
   */
  createPolicyNetwork(hiddenLayerSizes) {
    if (!Array.isArray(hiddenLayerSizes)) {
      hiddenLayerSizes = [hiddenLayerSizes];
    }
    this.policyNet = tf.sequential();
    hiddenLayerSizes.forEach((hiddenLayerSize, i) => {
      this.policyNet.add(tf.layers.dense({
        units: hiddenLayerSize,
        activation: 'elu',
        // `inputShape` is required only for the first layer.
        inputShape: i === 0 ? [4] : undefined
      }));
    });
    // The last layer has only one unit. The single output number will be
    // converted to a probability of selecting the leftward-force action.
    this.policyNet.add(tf.layers.dense({units: 1}));
  }

  /**
   * Train the policy network's model.
   *
   * @param {CartPole} cartPoleSystem The cart-pole system object to use during
   *   training.
   * @param {tf.train.Optimizer} optimizer An instance of TensorFlow.js
   *   Optimizer to use for training.
   * @param {number} discountRate Reward discounting rate: a number between 0
   *   and 1.
   * @param {number} numGames Number of game to play for each model parameter
   *   update.
   * @param {number} maxStepsPerGame Maximum number of steps to perform during
   *   a game. If this number is reached, the game will end immediately.
   * @returns {number[]} The number of steps completed in the `numGames` games
   *   in this round of training.
   */
  async train(
      cartPoleSystem, optimizer, discountRate, numGames, maxStepsPerGame) {
    const allGradients = [];
    const allRewards = [];
    const gameSteps = [];
    let a = 0;
    onGameEnd(0, numGames);
    for (let i = 0; i < numGames; ++i) {
      // Randomly initialize the state of the cart-pole system at the beginning
      // of every game.
      cartPoleSystem.setRandomState();
      c.visible = false;
      c = cylinder({pos:vec( 0, 0, 0), axis:vec(0,0.8,0),  radius: 0.03, color : color.cyan})
      a = 0
      const gameRewards = [];
      const gameGradients = [];
      for (let j = 0; j < maxStepsPerGame; ++j) {
        // For every step of the game, remember gradients of the policy
        // network's weights with respect to the probability of the action
        // choice that lead to the reward.
        const gradients = tf.tidy(() => {
          const inputTensor = cartPoleSystem.getStateTensor();
          return this.getGradientsAndSaveActions(inputTensor).grads;
        });

        this.pushGradients(gameGradients, gradients);
        const action = this.currentActions_[0];
        const isDone = cartPoleSystem.update(action)
        if (typeof c !== "undefined"){
          c.pos.x = b.pos.x = cartPoleSystem.x
          c.rotate({angle:-a, axis:vec(0,0,1)})
          a = cartPoleSystem.theta
          c.rotate({angle:a, axis:vec(0,0,1)})
        }

        await maybeRenderDuringTraining(cartPoleSystem);

        if (isDone) {
          // When the game ends before max step count is reached, a reward of
          // 0 is given.
          gameRewards.push(0);
          break;
        } else {
          // As long as the game doesn't end, each step leads to a reward of 1.
          // These reward values will later be "discounted", leading to
          // higher reward values for longer-lasting games.
          gameRewards.push(1);
        }
      }
      onGameEnd(i + 1, numGames);
      gameSteps.push(gameRewards.length);
      this.pushGradients(allGradients, gameGradients);
      allRewards.push(gameRewards);
      await tf.nextFrame();
    }

    tf.tidy(() => {
      // The following line does three things:
      // 1. Performs reward discounting, i.e., make recent rewards count more
      //    than rewards from the further past. The effect is that the reward
      //    values from a game with many steps become larger than the values
      //    from a game with fewer steps.
      // 2. Normalize the rewards, i.e., subtract the global mean value of the
      //    rewards and divide the result by the global standard deviation of
      //    the rewards. Together with step 1, this makes the rewards from
      //    long-lasting games positive and rewards from short-lasting
      //    negative.
      // 3. Scale the gradients with the normalized reward values.
      const normalizedRewards =
          discountAndNormalizeRewards(allRewards, discountRate);
      // Add the scaled gradients to the weights of the policy network. This
      // step makes the policy network more likely to make choices that lead
      // to long-lasting games in the future (i.e., the crux of this RL
      // algorithm.)
      optimizer.applyGradients(
          scaleAndAverageGradients(allGradients, normalizedRewards));
    });
    tf.dispose(allGradients);
    return gameSteps;
  }

  getGradientsAndSaveActions(inputTensor) {
    const f = () => tf.tidy(() => {
      const [logits, actions] = this.getLogitsAndActions(inputTensor);
      this.currentActions_ = actions.dataSync();
      const labels =
          tf.sub(1, tf.tensor2d(this.currentActions_, actions.shape));
      return tf.losses.sigmoidCrossEntropy(labels, logits).asScalar();
    });
    return tf.variableGrads(f);
  }

  getCurrentActions() {
    return this.currentActions_;
  }

  /**
   * Get policy-network logits and the action based on state-tensor inputs.
   *
   * @param {tf.Tensor} inputs A tf.Tensor instance of shape `[batchSize, 4]`.
   * @returns {[tf.Tensor, tf.Tensor]}
   *   1. The logits tensor, of shape `[batchSize, 1]`.
   *   2. The actions tensor, of shape `[batchSize, 1]`.
   */
  getLogitsAndActions(inputs) {
    return tf.tidy(() => {
      const logits = this.policyNet.predict(inputs);

      // Get the probability of the leftward action.
      const leftProb = tf.sigmoid(logits);
      // Probabilites of the left and right actions.
      const leftRightProbs = tf.concat([leftProb, tf.sub(1, leftProb)], 1);
      const actions = tf.multinomial(leftRightProbs, 1, null, true);
      return [logits, actions];
    });
  }

  /**
   * Get actions based on a state-tensor input.
   *
   * @param {tf.Tensor} inputs A tf.Tensor instance of shape `[batchSize, 4]`.
   * @param {Float32Array} inputs The actions for the inputs, with length
   *   `batchSize`.
   */
  getActions(inputs) {
    return this.getLogitsAndActions(inputs)[1].dataSync();
  }

  /**
   * Push a new dictionary of gradients into records.
   *
   * @param {{[varName: string]: tf.Tensor[]}} record The record of variable
   *   gradient: a map from variable name to the Array of gradient values for
   *   the variable.
   * @param {{[varName: string]: tf.Tensor}} gradients The new gradients to push
   *   into `record`: a map from variable name to the gradient Tensor.
   */
  pushGradients(record, gradients) {
    for (const key in gradients) {
      if (key in record) {
        record[key].push(gradients[key]);
      } else {
        record[key] = [gradients[key]];
      }
    }
  }
}

// The IndexedDB path where the model of the policy network will be saved.
const MODEL_SAVE_PATH_ = 'indexeddb://cart-pole-v1';

/**
 * A subclass of PolicyNetwork that supports saving and loading.
 */
class SaveablePolicyNetwork extends PolicyNetwork {
  /**
   * Constructor of SaveablePolicyNetwork
   *
   * @param {number | number[]} hiddenLayerSizesOrModel
   */
  constructor(hiddenLayerSizesOrModel) {
    super(hiddenLayerSizesOrModel);
  }

  /**
   * Save the model to IndexedDB.
   */
  async saveModel() {
    return await this.policyNet.save(MODEL_SAVE_PATH_);
  }

  /**
   * Load the model fom IndexedDB.
   *
   * @returns {SaveablePolicyNetwork} The instance of loaded
   *   `SaveablePolicyNetwork`.
   * @throws {Error} If no model can be found in IndexedDB.
   */
  static async loadModel() {
    const modelsInfo = await tf.io.listModels();
    if (MODEL_SAVE_PATH_ in modelsInfo) {
      console.log(`Loading existing model...`);
      const model = await tf.loadLayersModel(MODEL_SAVE_PATH_);
      console.log(`Loaded model from ${MODEL_SAVE_PATH_}`);
      return new SaveablePolicyNetwork(model);
    } else {
      throw new Error(`Cannot find model at ${MODEL_SAVE_PATH_}.`);
    }
  }

  /**
   * Check the status of locally saved model.
   *
   * @returns If the locally saved model exists, the model info as a JSON
   *   object. Else, `undefined`.
   */
  static async checkStoredModelStatus() {
    const modelsInfo = await tf.io.listModels();
    return modelsInfo[MODEL_SAVE_PATH_];
  }

  /**
   * Remove the locally saved model from IndexedDB.
   */
  async removeModel() {
    return await tf.io.removeModel(MODEL_SAVE_PATH_);
  }

  /**
   * Get the sizes of the hidden layers.
   *
   * @returns {number | number[]} If the model has only one hidden layer,
   *   return the size of the layer as a single number. If the model has
   *   multiple hidden layers, return the sizes as an Array of numbers.
   */
  hiddenLayerSizes() {
    const sizes = [];
    for (let i = 0; i < this.policyNet.layers.length - 1; ++i) {
      sizes.push(this.policyNet.layers[i].units);
    }
    return sizes.length === 1 ? sizes[0] : sizes;
  }
}

/**
 * Discount the reward values.
 *
 * @param {number[]} rewards The reward values to be discounted.
 * @param {number} discountRate Discount rate: a number between 0 and 1, e.g.,
 *   0.95.
 * @returns {tf.Tensor} The discounted reward values as a 1D tf.Tensor.
 */
function discountRewards(rewards, discountRate) {
  const discountedBuffer = tf.buffer([rewards.length]);
  let prev = 0;
  for (let i = rewards.length - 1; i >= 0; --i) {
    const current = discountRate * prev + rewards[i];
    discountedBuffer.set(current, i);
    prev = current;
  }
  return discountedBuffer.toTensor();
}

/**
 * Discount and normalize reward values.
 *
 * This function performs two steps:
 *
 * 1. Discounts the reward values using `discountRate`.
 * 2. Normalize the reward values with the global reward mean and standard
 *    deviation.
 *
 * @param {number[][]} rewardSequences Sequences of reward values.
 * @param {number} discountRate Discount rate: a number between 0 and 1, e.g.,
 *   0.95.
 * @returns {tf.Tensor[]} The discounted and normalize reward values as an
 *   Array of tf.Tensor.
 */
function discountAndNormalizeRewards(rewardSequences, discountRate) {
  return tf.tidy(() => {
    const discounted = [];
    for (const sequence of rewardSequences) {
      discounted.push(discountRewards(sequence, discountRate))
    }
    // Compute the overall mean and stddev.
    const concatenated = tf.concat(discounted);
    const mean = tf.mean(concatenated);
    const std = tf.sqrt(tf.mean(tf.square(concatenated.sub(mean))));
    // Normalize the reward sequences using the mean and std.
    const normalized = discounted.map(rs => rs.sub(mean).div(std));
    return normalized;
  });
}

/**
 * Scale the gradient values using normalized reward values and compute average.
 *
 * The gradient values are scaled by the normalized reward values. Then they
 * are averaged across all games and all steps.
 *
 * @param {{[varName: string]: tf.Tensor[][]}} allGradients A map from variable
 *   name to all the gradient values for the variable across all games and all
 *   steps.
 * @param {tf.Tensor[]} normalizedRewards An Array of normalized reward values
 *   for all the games. Each element of the Array is a 1D tf.Tensor of which
 *   the length equals the number of steps in the game.
 * @returns {{[varName: string]: tf.Tensor}} Scaled and averaged gradients
 *   for the variables.
 */
function scaleAndAverageGradients(allGradients, normalizedRewards) {
  return tf.tidy(() => {
    const gradients = {};
    for (const varName in allGradients) {
      gradients[varName] = tf.tidy(() => {
        // Stack gradients together.
        const varGradients = allGradients[varName].map(
            varGameGradients => tf.stack(varGameGradients));
        // Expand dimensions of reward tensors to prepare for multiplication
        // with broadcasting.
        const expandedDims = [];
        for (let i = 0; i < varGradients[0].rank - 1; ++i) {
          expandedDims.push(1);
        }
        const reshapedNormalizedRewards = normalizedRewards.map(
            rs => rs.reshape(rs.shape.concat(expandedDims)));
        for (let g = 0; g < varGradients.length; ++g) {
          // This mul() call uses broadcasting.
          varGradients[g] = varGradients[g].mul(reshapedNormalizedRewards[g]);
        }
        // Concatenate the scaled gradients together, then average them across
        // all the steps of all the games.
        return tf.mean(tf.concat(varGradients, 0), 0);
      });
    }
    return gradients;
  });
}

setUpUI();
</script>
<div class="glowscript" id="glowscript">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
<!-- Import tfjs-vis -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.4.0/dist/tfjs-vis.umd.min.js"></script>
<script src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery.min.js" type="text/javascript"></script>
<script src="https://s3.amazonaws.com/glowscript/lib/jquery/2.1/jquery-ui.custom.min.js" type="text/javascript"></script>
<script src="https://s3.amazonaws.com/glowscript/package/glow.3.0.min.js" type="text/javascript"></script>
<script type="text/javascript">
//--><![CDATA[//><!--

// START JAVASCRIPT
var b, c
;(function() {;
async function __main__() {
"use strict";

var version = ["3.0", "glowscript"];
Array.prototype.toString = function() { return __parsearray(this) };
var scene = canvas();
var vector = vec;

scene = canvas({range: 1.5})
b = box({pos:vec( 0, 0.0["-u"](), 0),  color : color.green, size:vec(0.25,0.1,0.2)})
c = cylinder({pos:vec( 0, 0, 0), axis:vec(0,0.8,0),  radius: 0.03, color : color.cyan})
var wire = cylinder({pos:vec( 10["-u"](), 0.0["-u"](), 0), axis:vec(20,0,0),  radius: 0.01, color : color.white})

}
;$(function(){ window.__context = { glowscript_container: $("#glowscript").removeAttr("id") }; __main__() })})()

// END JAVASCRIPT

//--><!
</script>
</div>
<h3>Ebooks</h3>
<p>2010 Feedback and Control for Everyone:</p>
<p style="padding-left: 30px;"><a href="https://link.springer.com/book/10.1007/978-3-642-03446-6">https://link.springer.com/book/10.1007/978-3-642-03446-6</a></p>
<p>2012 Mechatronic Systems: </p>
<p style="padding-left: 30px;"><a href="https://link.springer.com/book/10.1007/978-3-642-22324-2">https://link.springer.com/book/10.1007/978-3-642-22324-2</a> </p>
<p>2015 Feedback Control:</p>
<p style="padding-left: 30px;"><a href="https://link.springer.com/book/10.1007/978-1-4471-6675-7">https://link.springer.com/book/10.1007/978-1-4471-6675-7</a></p>
<p>2018 Reinforcement Learning for Optimal Feedback Control:</p>
<p style="padding-left: 30px;"><a href="https://link.springer.com/book/10.1007/978-3-319-78384-0">https://link.springer.com/book/10.1007/978-3-319-78384-0</a> </p>
<p><a href="/downloads/BookPythonForControl.pdf">2019 Python for Control.pdf</a></p>
<p>2020 Feedback:</p>
<p style="padding-left: 30px;"><a href="https://link.springer.com/book/10.1007/978-3-030-34839-7">https://link.springer.com/book/10.1007/978-3-030-34839-7</a> </p>
<p></p>
<h3>Feedback</h3>
<p style="padding-left: 30px;">針對 CoppeliaSim 中 Python Remote API 不提供的功能, 可以透過 Lua 製作, 然後再以 <a href="https://www.coppeliarobotics.com/helpFiles/en/remoteApiFunctionsPython.htm#simxCallScriptFunction">https://www.coppeliarobotics.com/helpFiles/en/remoteApiFunctionsPython.htm#simxCallScriptFunction</a> 呼叫. 相關討論請參考 <a href="https://forum.coppeliarobotics.com/viewtopic.php?t=7699">https://forum.coppeliarobotics.com/viewtopic.php?t=7699</a></p>
<h4><span style="background-color: #ffff99;">以下的 Inverted Pedulum 控制模擬可以視為專題 Task 之一:</span></h4>
<p style="padding-left: 30px;"><a href="https://github.com/mdecourse/vrep_inverted_pendulum">https://github.com/mdecourse/vrep_inverted_pendulum</a> 採用舊版的 Python2 以及舊版的 V-rep 製作, 可以嘗試改為 Python3 以及 CoppeliaSim 4.1.0 rev1 版本相容.</p>
<p style="padding-left: 30px;">Webots Inverted Pendulum:</p>
<p style="padding-left: 60px;"><a href="https://robotbenchmark.net/benchmark/inverted_pendulum/">https://robotbenchmark.net/benchmark/inverted_pendulum/</a> </p>
<p style="padding-left: 30px;"><a href="https://github.com/mdecourse/vrep-stuff">https://github.com/mdecourse/vrep-stuff</a></p>
<p style="padding-left: 30px;"><a href="http://ctms.engin.umich.edu/CTMS/index.php?example=InvertedPendulum&amp;section=SystemModeling">inverted pendulum system modeling</a></p>
<p style="padding-left: 30px;"><a href="/downloads/simulation of the inverted pendulum.pdf">simulation of the inverted pendulum.pdf</a></p>
<p style="padding-left: 30px;"><a href="https://ieeexplore.ieee.org/document/8833168">solve the inverted pendulum problem using DQN algorithm</a></p>
<p style="padding-left: 30px;"><a href="https://in.mathworks.com/help/control/ug/control-of-an-inverted-pendulum-on-a-cart.html">https://in.mathworks.com/help/control/ug/control-of-an-inverted-pendulum-on-a-cart.html</a></p>
<p> 磁浮控制系統:</p>
<p style="padding-left: 30px;"><a href="/downloads/Experiment_4_magnetic_levitation_control.pdf">Magnetic levitation control.pdf</a></p>
<p style="padding-left: 30px;"><a href="/downloads/Controller Design for a Magnetic Levitation Kit usingOpenModelica’s Integration with the Julia Language.pdf">Controller Design for a Magnetic Levitation Kit usingOpenModelica’s Integration with the Julia Language.pdf</a></p>
<p>CoppeliaSim Lua feedback PID Control:</p>
<pre class="brush:lua;auto-links:false;toolbar:false" contenteditable="false">function saturate(x,thr)
    if x&gt;thr then return thr end
    if x&lt;-thr then return -thr end
    return x
end

function PID_create(Kp,Ki,Kd)
    pid={}
    pid.pre_error=0.0
    pid.integral=0.0
    pid.Kp=Kp
    pid.Ki=Ki
    pid.Kd=Kd
    return pid
end

function PID(pid, setpoint, actual_position, dt)
    error=setpoint-actual_position
    if pid.Ki&gt;0.0 then
        pid.integral=pid.integral+error*dt
    end
    derivative=(error-pid.pre_error)/dt
    output=pid.Kp*error+saturate(pid.Ki*pid.integral,1000)+pid.Kd*derivative
    output=saturate(output,2000)
    pid.pre_error=error
    return output
end

if (sim_call_type==sim.syscb_init) then
    --graph=sim.getObjectHandle('Graph')
    pjoint=sim.getObjectHandle('pjoint')
    rjoint1=sim.getObjectHandle('rjoint1')
    pad=sim.getObjectHandle('pad')
    pidRot=PID_create(64.05,34.65,0.709)
    pidPos=PID_create(54,0,0.629)
    sim.addStatusbarMessage('angle controller = { P='..pidRot.Kp..'  I='..pidRot.Ki..'  D='..pidRot.Kd..' }   horizontal controller = { P='..pidPos.Kp..'  I='..pidPos.Ki..'  D='..pidPos.Kd..' }')
end

if (sim_call_type==sim.syscb_actuation) then  
    dt=sim.getSimulationTimeStep()
    u_angle=PID(pidRot, 0, sim.getJointPosition(rjoint1), dt)
    u_pos=PID(pidPos, 0, sim.getJointPosition(pjoint), dt)
   -- sim.setGraphUserData(graph,'e_ang',pid1.pre_error)
   -- sim.setGraphUserData(graph,'e_pos',pid2.pre_error)
    u=u_angle-u_pos
    sim.setJointTargetVelocity(pjoint,u)
end</pre>
<p></p>
<h3>CMSiMDE</h3>
<p><a href="https://github.com/mdecourse/cmsimde">https://github.com/mdecourse/cmsimde</a> 是一套以 Python + Flask 建構的網際內容管理系統, 以單人管理的模式建立, 其中包含動態網頁系統, 靜態網頁系統, Pelican 網誌與 Reveal.js 網際簡報系統.</p>
<p><a href="https://github.com/mdecourse/cmsimde">https://github.com/mdecourse/cmsimde</a> 執行需要:</p>
<p style="padding-left: 30px;">pip install flask flask_cors lxml bs4 markdown pelican leo</p>
<p style="padding-left: 30px;">等模組.</p>
<h3>Git</h3>
<h4>常用 Git 指令:</h4>
<p style="padding-left: 30px;">git clone --recurse-submodules <a href="https://github.com/mdecourse/cp2020.git">https://github.com/mdecourse/cp2020.git</a></p>
<p style="padding-left: 30px;">git submodule add <a href="https://github.com/mdecourse/cmsimde.git">https://github.com/mdecourse/cmsimde.git</a> cmsimde</p>
<p style="padding-left: 30px;">git remote add origin https://github.com/mdecourse/wcm1kmolinfo.git<br/>git add .<br/>git commit -m "message"<br/>git push -u --allow-unrelated-histories origin master</p>
<p style="padding-left: 30px;">git push --set-upstream origin master</p>
<h3>Windows</h3>
<h4>Windows 10 64 位元電腦中的可攜程式環境 </h4>
<h4 style="padding-left: 30px;">NX 高端電腦輔助機械設計套件</h4>
<p style="padding-left: 60px;">登入 @gm 帳號,<span> </span><a href="https://drive.google.com/file/d/1tiuq-KGeoCNA63IEkEWhGzSTFgdQUVM_/view?usp=sharing">下載 NX12 可攜版</a> (949MB)</p>
<p style="padding-left: 30px;">配置 2004 版本後測試 Python 可攜程式環境, 用來建立 <a href="https://github.com/mdecourse/cmsimde">CMSiMDE</a> 近端工作環境 (含 <a href="https://docs.plm.automation.siemens.com/tdoc/nx/12/nx_help/#uid:index">NX12</a> 與 <a href="https://www.coppeliarobotics.com/">CoppeliaSim</a> 操作)</p>
<p style="padding-left: 30px;">在 2004 版次中安裝 WSL 2, 安裝 Ubuntu 20.04 後啟用 <a href="https://github.com/mdecourse/cmsimde">CMSiMDE</a> 工作環境 <span> (含 <a href="https://docs.plm.automation.siemens.com/tdoc/nx/12/nx_help/#uid:index">NX12</a> 與 <a href="https://www.coppeliarobotics.com/">CoppeliaSim</a> 操作)</span></p>
<p style="padding-left: 30px;"><span>建立 <a href="https://www.virtualbox.org/">Virtualbox</a> <a href="https://docs.plm.automation.siemens.com/tdoc/nx/12/nx_help/#uid:index">NX12</a> 認證主機</span></p>
<p style="padding-left: 30px;"></p>
<h3>Ubuntu</h3>
<p>在 <a href="https://www.virtualbox.org/">Virtualbox</a> 與實體主機中利用 純 IPv6 網址, 配置 <a href="https://ubuntu.com/">Ubuntu</a> 20.04 部署動態與靜態 <a href="https://github.com/mdecourse/cmsimde">CMSiMDE</a> 網站 (含 <a href="https://letsencrypt.org/">Let's Encrypt</a> https 設置).</p>
<p><span>在 <a href="https://www.virtualbox.org/">Virtualbox</a> 與實體主機中利用 純 IPv6 網址, 配置 <a href="https://www.coppeliarobotics.com/">CoppeliaSim</a> 模擬系統, 用於建立虛擬機電控制系統.</span></p>
<p></p>
<h3>Heorku</h3>
<p>將近端與自架伺服器中的 <a href="https://github.com/mdecourse/cmsimde">CMSiMDE</a> 靜態網頁部署至 <a href="https://www.heroku.com/">Heroku</a>.</p>
<p>利用 <a href="https://www.heroku.com/">Heroku</a> 中的動態 Flask 程式與自架伺服器中的 <a href="https://www.coppeliarobotics.com/">CoppeliaSim</a> 模擬系統互動.</p>
<h4>Heroku 操作</h4>
<p>登入 @gm <a href="https://drive.google.com/file/d/1itKaIPSdIRZQ-qiLkUpxEPOLzSpP3eNY/view?usp=sharing">下載 Heroku cli 可攜.7z</a>, 解開壓縮檔案後, 在 start.bat 中將 Heroku bin 設定指令搜尋路徑, 重新啟動後, 以 heroku version 確定指令可以正常執行後, heroku login 成功後, 登入帳號密碼會存入 home/_netrc 中. 之後便可直接透過 heroku cli 指令直接對遠端主機下命令.</p>
<h3>Certbot</h3>
<p><a href="https://letsencrypt.org/">https://letsencrypt.org/</a> </p>
<h4>以下為實體主機配置 Certbot 時傳回資料:</h4>
<p style="padding-left: 30px;">IMPORTANT NOTES:<br/> - Congratulations! Your certificate and chain have been saved at:<br/>   /etc/letsencrypt/live/jcad.kmol.info/fullchain.pem<br/>   Your key file has been saved at:<br/>   /etc/letsencrypt/live/jcad.kmol.info/privkey.pem<br/>   Your cert will expire on 2020-12-18. To obtain a new or tweaked<br/>   version of this certificate in the future, simply run certbot<br/>   again. To non-interactively renew *all* of your certificates, run<br/>   "certbot renew"<br/> - Your account credentials have been saved in your Certbot<br/>   configuration directory at /etc/letsencrypt. You should make a<br/>   secure backup of this folder now. This configuration directory will<br/>   also contain certificates and private keys obtained by Certbot so<br/>   making regular backups of this folder is ideal.</p>
<p style="padding-left: 30px;">Test automatic renewal<br/><br/>The Certbot packages on your system come with a cron job or systemd timer that will renew your certificates automatically before they expire. You will not need to run Certbot again, unless you change your configuration. You can test automatic renewal for your certificates by running this command:<br/><br/>sudo certbot renew --dry-run<br/><br/>The command to renew certbot is installed in one of the following locations:<br/><br/>    /etc/crontab/<br/>    /etc/cron.*/*<br/>    systemctl list-timers</p>
<p style="padding-left: 30px;"></p>
<p></p>